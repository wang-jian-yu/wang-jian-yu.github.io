<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>elasticsearch（ELK） | Wang</title><meta name="description" content="ElasticSearch安装与介绍Elastic Stack简介如果你没有听说过Elastic Stack，那你一定听说过ELK，实际上ELK是三款软件的简称，分别是Elasticsearch、Logstash、Kibana组成，在发展的过程中，又有新成员Beats的加入，所以就形成了Elastic Stack。所以说，ELK是旧的称呼，Elastic Stack是新的名字。  全系的Elast"><meta name="keywords" content="elasticsearch"><meta name="author" content="小小王,1442243445@qq.com"><meta name="copyright" content="小小王"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/Banq-1.ico"><link rel="canonical" href="http://yoursite.com/2020/11/22/elasticsearch/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="elasticsearch（ELK）"><meta property="og:url" content="http://yoursite.com/2020/11/22/elasticsearch/"><meta property="og:site_name" content="Wang"><meta property="og:description" content="ElasticSearch安装与介绍Elastic Stack简介如果你没有听说过Elastic Stack，那你一定听说过ELK，实际上ELK是三款软件的简称，分别是Elasticsearch、Logstash、Kibana组成，在发展的过程中，又有新成员Beats的加入，所以就形成了Elastic Stack。所以说，ELK是旧的称呼，Elastic Stack是新的名字。  全系的Elast"><meta property="og:image" content="http://yoursite.com/img/bg6.jpg"><meta property="article:published_time" content="2020-11-22T01:28:24.000Z"><meta property="article:modified_time" content="2021-06-27T03:12:09.933Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="prev" title="webpack入门" href="http://yoursite.com/2020/11/26/webpack/"><link rel="next" title="设计模式" href="http://yoursite.com/2020/11/18/Design%20patterns/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="/css/move_mouse/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/StaticFile_HEXO@latest/butterfly/css/iconfont.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/StaticFile_HEXO@latest/butterfly/css/pool.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">58</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">53</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">38</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ElasticSearch安装与介绍"><span class="toc-number">1.</span> <span class="toc-text">ElasticSearch安装与介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Elastic-Stack简介"><span class="toc-number">1.1.</span> <span class="toc-text">Elastic Stack简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Elasticsearch"><span class="toc-number">1.1.1.</span> <span class="toc-text">Elasticsearch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Logstash"><span class="toc-number">1.1.2.</span> <span class="toc-text">Logstash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kibana"><span class="toc-number">1.1.3.</span> <span class="toc-text">Kibana</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Beats"><span class="toc-number">1.1.4.</span> <span class="toc-text">Beats</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch快速入门"><span class="toc-number">1.2.</span> <span class="toc-text">ElasticSearch快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介"><span class="toc-number">1.2.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前言"><span class="toc-number">1.2.2.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#下载"><span class="toc-number">1.2.3.</span> <span class="toc-text">下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#拉取Docker容器"><span class="toc-number">1.2.4.</span> <span class="toc-text">拉取Docker容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#单机版安装"><span class="toc-number">1.2.5.</span> <span class="toc-text">单机版安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动ElasticSearch"><span class="toc-number">1.2.6.</span> <span class="toc-text">启动ElasticSearch</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#错误分析"><span class="toc-number">1.3.</span> <span class="toc-text">错误分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#错误情况1"><span class="toc-number">1.3.1.</span> <span class="toc-text">错误情况1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#错误情况2"><span class="toc-number">1.3.2.</span> <span class="toc-text">错误情况2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#错误情况3"><span class="toc-number">1.3.3.</span> <span class="toc-text">错误情况3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#错误情况4"><span class="toc-number">1.3.4.</span> <span class="toc-text">错误情况4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#错误情况5"><span class="toc-number">1.3.5.</span> <span class="toc-text">错误情况5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#错误情况6"><span class="toc-number">1.3.6.</span> <span class="toc-text">错误情况6</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearchHead可视化工具"><span class="toc-number">1.4.</span> <span class="toc-text">ElasticSearchHead可视化工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#通过Docker方式安装"><span class="toc-number">1.4.1.</span> <span class="toc-text">通过Docker方式安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通过Chrome插件安装"><span class="toc-number">1.4.2.</span> <span class="toc-text">通过Chrome插件安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch中的基本概念"><span class="toc-number">1.5.</span> <span class="toc-text">ElasticSearch中的基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#索引"><span class="toc-number">1.5.1.</span> <span class="toc-text">索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文档"><span class="toc-number">1.5.2.</span> <span class="toc-text">文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#映射"><span class="toc-number">1.5.3.</span> <span class="toc-text">映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文档类型"><span class="toc-number">1.5.4.</span> <span class="toc-text">文档类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RESTful-API"><span class="toc-number">1.6.</span> <span class="toc-text">RESTful API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建非结构化索引"><span class="toc-number">1.6.1.</span> <span class="toc-text">创建非结构化索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建空索引"><span class="toc-number">1.6.2.</span> <span class="toc-text">创建空索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除索引"><span class="toc-number">1.6.3.</span> <span class="toc-text">删除索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#插入数据"><span class="toc-number">1.6.4.</span> <span class="toc-text">插入数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更新数据"><span class="toc-number">1.6.5.</span> <span class="toc-text">更新数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除索引-1"><span class="toc-number">1.6.6.</span> <span class="toc-text">删除索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#搜索数据"><span class="toc-number">1.6.7.</span> <span class="toc-text">搜索数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#根据id搜索数据"><span class="toc-number">1.6.7.1.</span> <span class="toc-text">根据id搜索数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#搜索全部数据"><span class="toc-number">1.6.7.2.</span> <span class="toc-text">搜索全部数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#关键字搜索数据"><span class="toc-number">1.6.7.3.</span> <span class="toc-text">关键字搜索数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DSL搜索"><span class="toc-number">1.6.8.</span> <span class="toc-text">DSL搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#全文搜索"><span class="toc-number">1.6.8.1.</span> <span class="toc-text">全文搜索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#聚合"><span class="toc-number">1.6.8.2.</span> <span class="toc-text">聚合</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch核心详解"><span class="toc-number">1.7.</span> <span class="toc-text">ElasticSearch核心详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#文档-1"><span class="toc-number">1.7.1.</span> <span class="toc-text">文档</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#元数据（metadata）"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">元数据（metadata）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#index"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">index</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#type"><span class="toc-number">1.7.1.3.</span> <span class="toc-text">_type</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#id"><span class="toc-number">1.7.1.4.</span> <span class="toc-text">_id</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询响应"><span class="toc-number">1.7.2.</span> <span class="toc-text">查询响应</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pretty"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">pretty</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#指定响应字段"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">指定响应字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#判断文档是否存在"><span class="toc-number">1.7.2.3.</span> <span class="toc-text">判断文档是否存在</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#批量操作"><span class="toc-number">1.7.3.</span> <span class="toc-text">批量操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#批量查询"><span class="toc-number">1.7.3.1.</span> <span class="toc-text">批量查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bulk操作"><span class="toc-number">1.7.3.2.</span> <span class="toc-text">_bulk操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分页"><span class="toc-number">1.7.4.</span> <span class="toc-text">分页</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#在集群系统中深度分页"><span class="toc-number">1.7.4.1.</span> <span class="toc-text">在集群系统中深度分页</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#映射-1"><span class="toc-number">1.7.5.</span> <span class="toc-text">映射</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建明确类型的索引："><span class="toc-number">1.7.5.1.</span> <span class="toc-text">创建明确类型的索引：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试搜索"><span class="toc-number">1.7.5.2.</span> <span class="toc-text">测试搜索</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#结构化查询"><span class="toc-number">1.7.6.</span> <span class="toc-text">结构化查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#term查询"><span class="toc-number">1.7.6.1.</span> <span class="toc-text">term查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#terms查询"><span class="toc-number">1.7.6.2.</span> <span class="toc-text">terms查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#range查询"><span class="toc-number">1.7.6.3.</span> <span class="toc-text">range查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exists-查询"><span class="toc-number">1.7.6.4.</span> <span class="toc-text">exists 查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#match查询"><span class="toc-number">1.7.6.5.</span> <span class="toc-text">match查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bool查询"><span class="toc-number">1.7.6.6.</span> <span class="toc-text">bool查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#过滤查询"><span class="toc-number">1.7.7.</span> <span class="toc-text">过滤查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#查询和过滤的对比"><span class="toc-number">1.7.7.1.</span> <span class="toc-text">查询和过滤的对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#建议："><span class="toc-number">1.7.7.2.</span> <span class="toc-text">建议：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#中文分词"><span class="toc-number">1.8.</span> <span class="toc-text">中文分词</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是分词"><span class="toc-number">1.8.1.</span> <span class="toc-text">什么是分词</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分词api"><span class="toc-number">1.8.2.</span> <span class="toc-text">分词api</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#中文分词难点"><span class="toc-number">1.8.3.</span> <span class="toc-text">中文分词难点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装分词器"><span class="toc-number">1.8.4.</span> <span class="toc-text">安装分词器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试"><span class="toc-number">1.8.5.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#全文搜索-1"><span class="toc-number">1.9.</span> <span class="toc-text">全文搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#构造数据"><span class="toc-number">1.9.1.</span> <span class="toc-text">构造数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#单词搜索"><span class="toc-number">1.9.2.</span> <span class="toc-text">单词搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#多词搜索"><span class="toc-number">1.9.3.</span> <span class="toc-text">多词搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#组合搜索"><span class="toc-number">1.9.4.</span> <span class="toc-text">组合搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#权重"><span class="toc-number">1.9.5.</span> <span class="toc-text">权重</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch集群"><span class="toc-number">1.10.</span> <span class="toc-text">ElasticSearch集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#集群节点"><span class="toc-number">1.10.1.</span> <span class="toc-text">集群节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#搭建集群"><span class="toc-number">1.10.2.</span> <span class="toc-text">搭建集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分片和副本"><span class="toc-number">1.10.3.</span> <span class="toc-text">分片和副本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#故障转移"><span class="toc-number">1.10.4.</span> <span class="toc-text">故障转移</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#将data节点停止"><span class="toc-number">1.10.4.1.</span> <span class="toc-text">将data节点停止</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#将master节点停止"><span class="toc-number">1.10.4.2.</span> <span class="toc-text">将master节点停止</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分布式文档"><span class="toc-number">1.10.5.</span> <span class="toc-text">分布式文档</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#路由"><span class="toc-number">1.10.5.1.</span> <span class="toc-text">路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#文档的写操作"><span class="toc-number">1.10.5.2.</span> <span class="toc-text">文档的写操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#搜索文档"><span class="toc-number">1.10.6.</span> <span class="toc-text">搜索文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#全文搜索-2"><span class="toc-number">1.10.7.</span> <span class="toc-text">全文搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#搜索（query）"><span class="toc-number">1.10.7.1.</span> <span class="toc-text">搜索（query）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#取回-fetch"><span class="toc-number">1.10.7.2.</span> <span class="toc-text">取回 fetch</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java客户端"><span class="toc-number">1.11.</span> <span class="toc-text">Java客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#REST客户端"><span class="toc-number">1.11.1.</span> <span class="toc-text">REST客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#构造数据-1"><span class="toc-number">1.11.2.</span> <span class="toc-text">构造数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#REST低级客户端"><span class="toc-number">1.11.3.</span> <span class="toc-text">REST低级客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#REST高级客户端"><span class="toc-number">1.11.4.</span> <span class="toc-text">REST高级客户端</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Beats入门简介"><span class="toc-number">2.</span> <span class="toc-text">Beats入门简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#项目需求"><span class="toc-number">2.1.</span> <span class="toc-text">项目需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#业务流程"><span class="toc-number">2.2.</span> <span class="toc-text">业务流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署Nginx"><span class="toc-number">2.3.</span> <span class="toc-text">部署Nginx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Beats简介"><span class="toc-number">2.4.</span> <span class="toc-text">Beats简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Filebeat"><span class="toc-number">2.5.</span> <span class="toc-text">Filebeat</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#介绍"><span class="toc-number">2.5.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么要用Filebeat？"><span class="toc-number">2.5.2.</span> <span class="toc-text">为什么要用Filebeat？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#架构"><span class="toc-number">2.5.3.</span> <span class="toc-text">架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#下载-1"><span class="toc-number">2.5.4.</span> <span class="toc-text">下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动"><span class="toc-number">2.5.5.</span> <span class="toc-text">启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#读取文件"><span class="toc-number">2.5.6.</span> <span class="toc-text">读取文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义字段"><span class="toc-number">2.5.7.</span> <span class="toc-text">自定义字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#输出到ElasticSearch"><span class="toc-number">2.5.8.</span> <span class="toc-text">输出到ElasticSearch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filebeat工作原理"><span class="toc-number">2.5.9.</span> <span class="toc-text">Filebeat工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#harvester"><span class="toc-number">2.5.9.1.</span> <span class="toc-text">harvester</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#prospector"><span class="toc-number">2.5.9.2.</span> <span class="toc-text">prospector</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#input"><span class="toc-number">2.5.10.</span> <span class="toc-text">input</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动命令"><span class="toc-number">2.5.11.</span> <span class="toc-text">启动命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参数说明"><span class="toc-number">2.5.12.</span> <span class="toc-text">参数说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#读取Nginx中的配置文件"><span class="toc-number">2.5.13.</span> <span class="toc-text">读取Nginx中的配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Module"><span class="toc-number">2.5.14.</span> <span class="toc-text">Module</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx-module-配置"><span class="toc-number">2.5.14.1.</span> <span class="toc-text">nginx module 配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置filebeat"><span class="toc-number">2.5.14.2.</span> <span class="toc-text">配置filebeat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试-1"><span class="toc-number">2.5.14.3.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Metricbeat"><span class="toc-number">2.6.</span> <span class="toc-text">Metricbeat</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Metricbeat组成"><span class="toc-number">2.6.1.</span> <span class="toc-text">Metricbeat组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#下载-2"><span class="toc-number">2.6.2.</span> <span class="toc-text">下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动-1"><span class="toc-number">2.6.3.</span> <span class="toc-text">启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#system-module配置"><span class="toc-number">2.6.4.</span> <span class="toc-text">system module配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Metricbeat-Module"><span class="toc-number">2.6.5.</span> <span class="toc-text">Metricbeat Module</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-Module"><span class="toc-number">2.6.6.</span> <span class="toc-text">Nginx Module</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#开启Nginx-Module"><span class="toc-number">2.6.6.1.</span> <span class="toc-text">开启Nginx Module</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置nginx-module"><span class="toc-number">2.6.7.</span> <span class="toc-text">配置nginx module</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试-2"><span class="toc-number">2.6.8.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">2.7.</span> <span class="toc-text">参考</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kibana入门"><span class="toc-number">3.</span> <span class="toc-text">Kibana入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#配置和安装"><span class="toc-number">3.1.</span> <span class="toc-text">配置和安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#启动-2"><span class="toc-number">3.2.</span> <span class="toc-text">启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#功能说明"><span class="toc-number">3.3.</span> <span class="toc-text">功能说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据探索"><span class="toc-number">3.4.</span> <span class="toc-text">数据探索</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Metricbeat仪表盘"><span class="toc-number">3.5.</span> <span class="toc-text">Metricbeat仪表盘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx指标仪表盘【Metricbeat】"><span class="toc-number">3.6.</span> <span class="toc-text">Nginx指标仪表盘【Metricbeat】</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx日志仪表盘"><span class="toc-number">3.7.</span> <span class="toc-text">Nginx日志仪表盘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kibana自定义仪表盘"><span class="toc-number">3.8.</span> <span class="toc-text">Kibana自定义仪表盘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开发者工具"><span class="toc-number">3.9.</span> <span class="toc-text">开发者工具</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Logstash入门简介"><span class="toc-number">4.</span> <span class="toc-text">Logstash入门简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍-1"><span class="toc-number">4.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#用途"><span class="toc-number">4.2.</span> <span class="toc-text">用途</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署安装"><span class="toc-number">4.3.</span> <span class="toc-text">部署安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试-3"><span class="toc-number">4.4.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置详解"><span class="toc-number">4.5.</span> <span class="toc-text">配置详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#输入"><span class="toc-number">4.5.1.</span> <span class="toc-text">输入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#过滤"><span class="toc-number">4.5.2.</span> <span class="toc-text">过滤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#输出"><span class="toc-number">4.5.3.</span> <span class="toc-text">输出</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#读取自定义日志"><span class="toc-number">4.6.</span> <span class="toc-text">读取自定义日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#日志结构"><span class="toc-number">4.6.1.</span> <span class="toc-text">日志结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写配置文件"><span class="toc-number">4.6.2.</span> <span class="toc-text">编写配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#输出到Elasticsearch"><span class="toc-number">4.6.3.</span> <span class="toc-text">输出到Elasticsearch</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ElasticStack综合案例"><span class="toc-number">5.</span> <span class="toc-text">ElasticStack综合案例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#流程说明"><span class="toc-number">5.1.</span> <span class="toc-text">流程说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#App介绍"><span class="toc-number">5.2.</span> <span class="toc-text">App介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置Filebeat"><span class="toc-number">5.3.</span> <span class="toc-text">配置Filebeat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置Logstash"><span class="toc-number">5.4.</span> <span class="toc-text">配置Logstash</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Logstash输出到控制台"><span class="toc-number">5.4.1.</span> <span class="toc-text">Logstash输出到控制台</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置Logstash连接ElasticSearch"><span class="toc-number">5.4.2.</span> <span class="toc-text">配置Logstash连接ElasticSearch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#遇到的问题1"><span class="toc-number">5.4.3.</span> <span class="toc-text">遇到的问题1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#遇到的问题2"><span class="toc-number">5.4.4.</span> <span class="toc-text">遇到的问题2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#启动ElasticSearch-1"><span class="toc-number">5.5.</span> <span class="toc-text">启动ElasticSearch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#启动Kibana"><span class="toc-number">5.6.</span> <span class="toc-text">启动Kibana</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#添加到索引库"><span class="toc-number">5.6.1.</span> <span class="toc-text">添加到索引库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建柱形图"><span class="toc-number">5.6.2.</span> <span class="toc-text">创建柱形图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建饼图"><span class="toc-number">5.6.3.</span> <span class="toc-text">创建饼图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据表格"><span class="toc-number">5.6.4.</span> <span class="toc-text">数据表格</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#制作Dashboard"><span class="toc-number">5.7.</span> <span class="toc-text">制作Dashboard</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/bg6.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">Wang</a></span><span class="pull-right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">elasticsearch（ELK）</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-11-22 09:28:24"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2020-11-22</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2021-06-27 11:12:09"><i class="fas fa-history fa-fw"></i> 更新于 2021-06-27</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/elasticsearch/">elasticsearch</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="ElasticSearch安装与介绍"><a href="#ElasticSearch安装与介绍" class="headerlink" title="ElasticSearch安装与介绍"></a>ElasticSearch安装与介绍</h1><h2 id="Elastic-Stack简介"><a href="#Elastic-Stack简介" class="headerlink" title="Elastic Stack简介"></a>Elastic Stack简介</h2><p>如果你没有听说过Elastic Stack，那你一定听说过ELK，实际上ELK是三款软件的简称，分别是Elasticsearch、<br>Logstash、Kibana组成，在发展的过程中，又有新成员Beats的加入，所以就形成了Elastic Stack。所以说，ELK是旧的称呼，Elastic Stack是新的名字。</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201123094631999.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>全系的Elastic Stack技术栈包括：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201123094647557.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h3 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h3><p>Elasticsearch 基于java，是个开源分布式搜索引擎，它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。</p>
<h3 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h3><p>Logstash 基于java，是一个开源的用于收集,分析和存储日志的工具。</p>
<h3 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h3><p>Kibana 基于nodejs，也是一个开源和免费的工具，Kibana可以为 Logstash 和 ElasticSearch 提供的日志分析友好的Web 界面，可以汇总、分析和搜索重要数据日志。</p>
<h3 id="Beats"><a href="#Beats" class="headerlink" title="Beats"></a>Beats</h3><p>Beats是elastic公司开源的一款采集系统监控数据的代理agent，是在被监控服务器上以客户端形式运行的数据收集器的统称，可以直接把数据发送给Elasticsearch或者通过Logstash发送给Elasticsearch，然后进行后续的数据分析活动。Beats由如下组成:</p>
<ul>
<li>Packetbeat：是一个网络数据包分析器，用于监控、收集网络流量信息，Packetbeat嗅探服务器之间的流量，解析应用层协议，并关联到消息的处理，其支 持ICMP (v4 and v6)、DNS、HTTP、Mysql、PostgreSQL、Redis、MongoDB、Memcache等协议；</li>
<li>Filebeat：用于监控、收集服务器日志文件，其已取代 logstash forwarder；</li>
<li>Metricbeat：可定期获取外部系统的监控指标信息，其可以监控、收集 Apache、HAProxy、MongoDB<br>MySQL、Nginx、PostgreSQL、Redis、System、Zookeeper等服务；</li>
</ul>
<blockquote>
<p>Beats和Logstash其实都可以进行数据的采集，但是目前主流的是使用Beats进行数据采集，然后使用 Logstash进行数据的分割处理等，早期没有Beats的时候，使用的就是Logstash进行数据的采集。</p>
</blockquote>
<h2 id="ElasticSearch快速入门"><a href="#ElasticSearch快速入门" class="headerlink" title="ElasticSearch快速入门"></a>ElasticSearch快速入门</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>官网：<a href="https://www.elastic.co/" target="_blank" rel="noopener">https://www.elastic.co/</a></p>
<p>ElasticSearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。设计用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。</p>
<p>我们建立一个网站或应用程序，并要添加搜索功能，但是想要完成搜索工作的创建是非常困难的。我们希望搜索解决方案要运行速度快，我们希望能有一个零配置和一个完全免费的搜索模式，我们希望能够简单地使用JSON通过HTTP来索引数据，我们希望我们的搜索服务器始终可用，我们希望能够从一台开始并扩展到数百台，我们要实时搜索，我们要简单的多租户，我们希望建立一个云的解决方案。因此我们利用Elasticsearch来解决所有这些问题及可能出现的更多其它问题。</p>
<p>ElasticSearch是Elastic Stack的核心，同时Elasticsearch 是一个分布式、RESTful风格的搜索和数据分析引擎，能够解决不断涌现出的各种用例。作为Elastic Stack的核心，它集中存储您的数据，帮助您发现意料之中以及意料之外的情况。</p>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>Elasticsearch的发展是非常快速的，所以在ES5.0之前，ELK的各个版本都不统一，出现了版本号混乱的状态，所以从5.0开始，所有Elastic Stack中的项目全部统一版本号。目前最新版本是6.5.4，我们将基于这一版本进行学习。</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201123104435444.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>到官网下载：<a href="https://www.elastic.co/cn/downloads/" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/</a></p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201124091322914.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>选择对应版本的数据，这里我使用的是Linux来进行安装，所以就先下载好ElasticSearch的Linux安装包</p>
<h3 id="拉取Docker容器"><a href="#拉取Docker容器" class="headerlink" title="拉取Docker容器"></a>拉取Docker容器</h3><p>因为我们需要部署在Linux下，为了以后迁移ElasticStack环境方便，我们就使用Docker来进行部署，首先我们拉取一个带有ssh的centos docker镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拉取镜像</span></span><br><span class="line">docker pull moxi/centos_ssh</span><br><span class="line"><span class="comment"># 制作容器</span></span><br><span class="line">docker run --privileged -d -it -h ElasticStack --name ElasticStack -p 11122:22 -p 9200:9200 -p 5601:5601 -p 9300:9300 -v /etc/localtime:/etc/localtime:ro  moxi/centos_ssh /usr/sbin/init</span><br></pre></td></tr></table></figure>

<p>然后直接远程连接11122端口即可</p>
<h3 id="单机版安装"><a href="#单机版安装" class="headerlink" title="单机版安装"></a>单机版安装</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--笔者使用docker</span><br><span class="line">docker run -e ES_JAVA_OPTS=<span class="string">"-Xms256m -Xmx256m"</span> -d -p <span class="number">9200</span>:<span class="number">9200</span> -p <span class="number">9300</span>:<span class="number">9300</span> --name es elasticsearch:<span class="number">6.7</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>

<p>因为ElasticSearch不支持Root用户直接操作，因此我们需要创建一个elsearch用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加新用户</span></span><br><span class="line">useradd elsearch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个soft目录，存放下载的软件</span></span><br><span class="line">mkdir /soft</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入，然后通过xftp工具，将刚刚下载的文件拖动到该目录下</span></span><br><span class="line"><span class="built_in">cd</span> /soft</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压缩</span></span><br><span class="line">tar -zxvf elasticsearch-7.9.1-linux-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#重命名</span></span><br><span class="line">mv elasticsearch-7.9.1/ elsearch</span><br></pre></td></tr></table></figure>

<p>因为刚刚我们是使用root用户操作的，所以我们还需要更改一下/soft文件夹的所属，改为elsearch用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown elsearch:elsearch /soft/ -R</span><br></pre></td></tr></table></figure>

<p>然后在切换成elsearch用户进行操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换用户</span></span><br><span class="line">su - elsearch</span><br></pre></td></tr></table></figure>

<p>然后我们就可以对我们的配置文件进行修改了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入到 elsearch下的config目录</span></span><br><span class="line"><span class="built_in">cd</span> /soft/elsearch/config</span><br></pre></td></tr></table></figure>

<p>然后找到下面的配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#打开配置文件</span></span><br><span class="line"><span class="string">vim</span> <span class="string">elasticsearch.yml</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#设置ip地址，任意网络均可访问</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>

<p>在Elasticsearch中如果，network.host不是localhost或者127.0.0.1的话，就会认为是生产环境，会对环境的要求比较高，我们的测试环境不一定能够满足，一般情况下需要修改2处配置，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改jvm启动参数</span></span><br><span class="line">vim conf/jvm.options</span><br><span class="line"></span><br><span class="line"><span class="comment">#根据自己机器情况修改</span></span><br><span class="line">-Xms128m </span><br><span class="line">-Xmx128m</span><br></pre></td></tr></table></figure>

<p>然后在修改第二处的配置，这个配置要求我们到宿主机器上来进行配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 到宿主机上打开文件</span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 增加这样一条配置，一个进程在VMAs(虚拟内存区域)创建内存映射最大数量</span></span><br><span class="line">vm.max_map_count=655360</span><br><span class="line"><span class="comment"># 让配置生效</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<h3 id="启动ElasticSearch"><a href="#启动ElasticSearch" class="headerlink" title="启动ElasticSearch"></a>启动ElasticSearch</h3><p>首先我们需要切换到 elsearch用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - elsearch</span><br></pre></td></tr></table></figure>

<p>然后在到bin目录下，执行下面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入bin目录</span></span><br><span class="line"><span class="built_in">cd</span> /soft/elsearch/bin</span><br><span class="line"><span class="comment"># 后台启动</span></span><br><span class="line">./elasticsearch -d</span><br></pre></td></tr></table></figure>

<p>启动成功后，访问下面的URL</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://202.193.56.222:9200/</span><br></pre></td></tr></table></figure>

<p>如果出现了下面的信息，就表示已经成功启动了</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125085754171.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>如果你在启动的时候，遇到过问题，那么请参考下面的错误分析~</p>
<h2 id="错误分析"><a href="#错误分析" class="headerlink" title="错误分析"></a>错误分析</h2><h3 id="错误情况1"><a href="#错误情况1" class="headerlink" title="错误情况1"></a>错误情况1</h3><p>如果出现下面的错误信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException: can not run elasticsearch as root</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap.initializeNatives(Bootstrap.java:111)</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap.setup(Bootstrap.java:178)</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:393)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:170)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:161)</span><br><span class="line">	at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:86)</span><br><span class="line">	at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:127)</span><br><span class="line">	at org.elasticsearch.cli.Command.main(Command.java:90)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:126)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:92)</span><br><span class="line">For complete error details, refer to the log at &#x2F;soft&#x2F;elsearch&#x2F;logs&#x2F;elasticsearch.log</span><br><span class="line">[root@e588039bc613 bin]# 2020-09-22 02:59:39,537121 UTC [536] ERROR CLogger.cc@310 Cannot log to named pipe &#x2F;tmp&#x2F;elasticsearch-5834501324803693929&#x2F;controller_log_381 as it could not be opened for writing</span><br><span class="line">2020-09-22 02:59:39,537263 UTC [536] INFO  Main.cc@103 Parent process died - ML controller exiting</span><br></pre></td></tr></table></figure>

<p>就说明你没有切换成 elsearch用户，因为不能使用root操作es</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - elsearch</span><br></pre></td></tr></table></figure>

<h3 id="错误情况2"><a href="#错误情况2" class="headerlink" title="错误情况2"></a>错误情况2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[1]:max file descriptors [4096] <span class="keyword">for</span> elasticsearch process is too low, increase to at least[65536]</span><br></pre></td></tr></table></figure>

<p>解决方法：切换到root用户，编辑limits.conf添加如下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># ElasticSearch添加如下内容:</span></span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 131072</span><br><span class="line">* soft nproc 2048</span><br><span class="line">* hard nproc 4096</span><br></pre></td></tr></table></figure>

<h3 id="错误情况3"><a href="#错误情况3" class="headerlink" title="错误情况3"></a>错误情况3</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[2]: max number of threads [1024] <span class="keyword">for</span> user [elsearch] is too low, increase to at least</span><br><span class="line">[4096]</span><br></pre></td></tr></table></figure>

<p>也就是最大线程数设置的太低了，需要改成4096</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#解决：切换到root用户，进入limits.d目录下修改配置文件。</span></span><br><span class="line">vi /etc/security/limits.d/90-nproc.conf</span><br><span class="line"><span class="comment">#修改如下内容：</span></span><br><span class="line">* soft nproc 1024</span><br><span class="line"><span class="comment">#修改为</span></span><br><span class="line">* soft nproc 4096</span><br></pre></td></tr></table></figure>

<h3 id="错误情况4"><a href="#错误情况4" class="headerlink" title="错误情况4"></a>错误情况4</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[3]: system call filters failed to install; check the logs and fix your configuration</span><br><span class="line">or <span class="built_in">disable</span> system call filters at your own risk</span><br></pre></td></tr></table></figure>

<p>解决：Centos6不支持SecComp，而ES5.2.0默认bootstrap.system_call_filter为true</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim config/elasticsearch.yml</span><br><span class="line"><span class="comment"># 添加</span></span><br><span class="line">bootstrap.system_call_filter: <span class="literal">false</span></span><br><span class="line">bootstrap.memory_lock: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h3 id="错误情况5"><a href="#错误情况5" class="headerlink" title="错误情况5"></a>错误情况5</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[elsearch@e588039bc613 bin]$ Exception <span class="keyword">in</span> thread <span class="string">"main"</span> org.elasticsearch.bootstrap.BootstrapException: java.nio.file.AccessDeniedException: /soft/elsearch/config/elasticsearch.keystore</span><br><span class="line">Likely root cause: java.nio.file.AccessDeniedException: /soft/elsearch/config/elasticsearch.keystore</span><br><span class="line">	at java.base/sun.nio.fs.UnixException.translateToIOException(UnixException.java:90)</span><br><span class="line">	at java.base/sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:111)</span><br><span class="line">	at java.base/sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:116)</span><br><span class="line">	at java.base/sun.nio.fs.UnixFileSystemProvider.newByteChannel(UnixFileSystemProvider.java:219)</span><br><span class="line">	at java.base/java.nio.file.Files.newByteChannel(Files.java:375)</span><br><span class="line">	at java.base/java.nio.file.Files.newByteChannel(Files.java:426)</span><br><span class="line">	at org.apache.lucene.store.SimpleFSDirectory.openInput(SimpleFSDirectory.java:79)</span><br><span class="line">	at org.elasticsearch.common.settings.KeyStoreWrapper.load(KeyStoreWrapper.java:220)</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap.loadSecureSettings(Bootstrap.java:240)</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:349)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:170)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:161)</span><br><span class="line">	at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:86)</span><br><span class="line">	at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:127)</span><br><span class="line">	at org.elasticsearch.cli.Command.main(Command.java:90)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:126)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:92)</span><br></pre></td></tr></table></figure>

<p>我们通过排查，发现是因为 /soft/elsearch/config/elasticsearch.keystore 存在问题</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125085728365.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>也就是说该文件还是所属于root用户，而我们使用elsearch用户无法操作，所以需要把它变成elsearch</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown elsearch:elsearch elasticsearch.keystore</span><br></pre></td></tr></table></figure>

<h3 id="错误情况6"><a href="#错误情况6" class="headerlink" title="错误情况6"></a>错误情况6</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[1]: the default discovery settings are unsuitable <span class="keyword">for</span> production use; at least one of [discovery.seed_hosts, discovery.seed_providers, cluster.initial_master_nodes] must be configured</span><br><span class="line">ERROR: Elasticsearch did not <span class="built_in">exit</span> normally - check the logs at /soft/elsearch/logs/elasticsearch.log</span><br></pre></td></tr></table></figure>

<p>继续修改配置 elasticsearch.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 取消注释，并保留一个节点</span></span><br><span class="line">node.name: node-1</span><br><span class="line">cluster.initial_master_nodes: [<span class="string">"node-1"</span>]</span><br></pre></td></tr></table></figure>



<h2 id="ElasticSearchHead可视化工具"><a href="#ElasticSearchHead可视化工具" class="headerlink" title="ElasticSearchHead可视化工具"></a>ElasticSearchHead可视化工具</h2><p>由于ES官方没有给ES提供可视化管理工具，仅仅是提供了后台的服务，elasticsearch-head是一个为ES开发的一个页面客户端工具，其源码托管于Github，地址为 <a href="https://github.com/mobz/elasticsearch-head" target="_blank" rel="noopener">传送门</a></p>
<p>head提供了以下安装方式</p>
<ul>
<li>源码安装，通过npm run start启动（不推荐）</li>
<li>通过docker安装（推荐）</li>
<li>通过chrome插件安装（推荐）</li>
<li>通过ES的plugin方式安装（不推荐）</li>
</ul>
<h3 id="通过Docker方式安装"><a href="#通过Docker方式安装" class="headerlink" title="通过Docker方式安装"></a>通过Docker方式安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#拉取镜像</span></span><br><span class="line">docker pull mobz/elasticsearch-head:5</span><br><span class="line"><span class="comment">#创建容器</span></span><br><span class="line">docker create --name elasticsearch-head -p 9100:9100 mobz/elasticsearch-head:5</span><br><span class="line"><span class="comment">#启动容器</span></span><br><span class="line">docker start elasticsearch-head</span><br></pre></td></tr></table></figure>

<p>通过浏览器进行访问：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125091551112.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>注意：<br>由于前后端分离开发，所以会存在跨域问题，需要在服务端做CORS的配置，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim elasticsearch.yml</span><br><span class="line"></span><br><span class="line">http.cors.enabled: <span class="literal">true</span> http.cors.allow-origin: <span class="string">"*"</span></span><br></pre></td></tr></table></figure>

<p>通过chrome插件的方式安装不存在该问题</p>
<h3 id="通过Chrome插件安装"><a href="#通过Chrome插件安装" class="headerlink" title="通过Chrome插件安装"></a>通过Chrome插件安装</h3><p>打开chrome的应用商店，即可安装 <a href="https://chrome.google.com/webstore/detail/elasticsearch-head/ffmkiejjmecolpfloofpjologoblkegm" target="_blank" rel="noopener">https://chrome.google.com/webstore/detail/elasticsearch-head/ffmkiejjmecolpfloofpjologoblkegm</a></p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/2020112509161549.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>我们也可以新建索引</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125091638918.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>建议：推荐使用chrome插件的方式安装，如果网络环境不允许，就采用其它方式安装。</p>
<h2 id="ElasticSearch中的基本概念"><a href="#ElasticSearch中的基本概念" class="headerlink" title="ElasticSearch中的基本概念"></a>ElasticSearch中的基本概念</h2><h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><ul>
<li>索引（index）是Elasticsearch对逻辑数据的逻辑存储，所以它可以分为更小的部分。</li>
<li>可以把索引看成关系型数据库的表，索引的结构是为快速有效的全文索引准备的，特别是它不存储原始值。</li>
<li>Elasticsearch可以把索引存放在一台机器或者分散在多台服务器上，每个索引有一或多个分片（shard），每个分片可以有多个副本（replica）。</li>
</ul>
<h3 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h3><ul>
<li>存储在Elasticsearch中的主要实体叫文档（document）。用关系型数据库来类比的话，一个文档相当于数据库表中的一行记录。</li>
<li>Elasticsearch和MongoDB中的文档类似，都可以有不同的结构，但Elasticsearch的文档中，相同字段必须有相同类型。</li>
<li>文档由多个字段组成，每个字段可能多次出现在一个文档里，这样的字段叫多值字段（multivalued）。<br>每个字段的类型，可以是文本、数值、日期等。字段类型也可以是复杂类型，一个字段包含其他子文档或者数<br>组。</li>
</ul>
<h3 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h3><p>所有文档写进索引之前都会先进行分析，如何将输入的文本分割为词条、哪些词条又会被过滤，这种行为叫做<br>映射（mapping）。一般由用户自己定义规则。</p>
<h3 id="文档类型"><a href="#文档类型" class="headerlink" title="文档类型"></a>文档类型</h3><ul>
<li>在Elasticsearch中，一个索引对象可以存储很多不同用途的对象。例如，一个博客应用程序可以保存文章和评<br>论。</li>
<li>每个文档可以有不同的结构。</li>
<li>不同的文档类型不能为相同的属性设置不同的类型。例如，在同一索引中的所有文档类型中，一个叫title的字段必须具有相同的类型。</li>
</ul>
<h2 id="RESTful-API"><a href="#RESTful-API" class="headerlink" title="RESTful API"></a>RESTful API</h2><p>在Elasticsearch中，提供了功能丰富的RESTful API的操作，包括基本的CRUD、创建索引、删除索引等操作。</p>
<h3 id="创建非结构化索引"><a href="#创建非结构化索引" class="headerlink" title="创建非结构化索引"></a>创建非结构化索引</h3><p>在Lucene中，创建索引是需要定义字段名称以及字段的类型的，在Elasticsearch中提供了非结构化的索引，就是不需要创建索引结构，即可写入数据到索引中，实际上在Elasticsearch底层会进行结构化操作，此操作对用户是透明的。</p>
<h3 id="创建空索引"><a href="#创建空索引" class="headerlink" title="创建空索引"></a>创建空索引</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /haoke</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"settings"</span>: &#123;</span><br><span class="line">        <span class="string">"index"</span>: &#123;</span><br><span class="line">        <span class="string">"number_of_shards"</span>: <span class="string">"2"</span>, <span class="comment">#分片数</span></span><br><span class="line">        <span class="string">"number_of_replicas"</span>: <span class="string">"0"</span> <span class="comment">#副本数</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除索引</span></span><br><span class="line">DELETE /haoke</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"acknowledged"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h3><blockquote>
<p>URL规则：<br>POST /{索引}/{类型}/{id}</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /haoke/user/1001</span><br><span class="line"><span class="comment">#数据</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"id"</span>:1001,</span><br><span class="line"><span class="string">"name"</span>:<span class="string">"张三"</span>,</span><br><span class="line"><span class="string">"age"</span>:20,</span><br><span class="line"><span class="string">"sex"</span>:<span class="string">"男"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用postman操作成功后</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125093652550.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>我们通过ElasticSearchHead进行数据预览就能够看到我们刚刚插入的数据了</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125093723978.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>说明：非结构化的索引，不需要事先创建，直接插入数据默认创建索引。不指定id插入数据：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125093737467.png#pic_center" alt="在这里插入图片描述"></p>
<h3 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h3><p>在Elasticsearch中，文档数据是不为修改的，但是可以通过覆盖的方式进行更新。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /haoke/user/1001</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"id"</span>:1001,</span><br><span class="line"><span class="string">"name"</span>:<span class="string">"张三"</span>,</span><br><span class="line"><span class="string">"age"</span>:21,</span><br><span class="line"><span class="string">"sex"</span>:<span class="string">"女"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更新结果如下：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125095315552.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125095353498.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>可以看到数据已经被覆盖了。问题来了，可以局部更新吗？ – 可以的。前面不是说，文档数据不能更新吗？ 其实是这样的：在内部，依然会查询到这个文档数据，然后进行覆盖操作，步骤如下：</p>
<ol>
<li>从旧文档中检索JSON</li>
<li>修改它</li>
<li>删除旧文档</li>
<li>索引新文档</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意：这里多了_update标识</span></span><br><span class="line">POST /haoke/user/1001/_update</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"doc"</span>:&#123;</span><br><span class="line"><span class="string">"age"</span>:23</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125095741790.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125095804985.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>可以看到，数据已经是局部更新了</p>
<h3 id="删除索引-1"><a href="#删除索引-1" class="headerlink" title="删除索引"></a>删除索引</h3><p>在Elasticsearch中，删除文档数据，只需要发起DELETE请求即可，不用额外的参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE 1 /haoke/user/1001</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125095901977.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>需要注意的是，result表示已经删除，version也增加了。</p>
<p>如果删除一条不存在的数据，会响应404</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/2020112509592980.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<blockquote>
<p>删除一个文档也不会立即从磁盘上移除，它只是被标记成已删除。Elasticsearch将会在你之后添加更多索引的时候才会在后台进行删除内容的清理。【相当于批量操作】</p>
</blockquote>
<h3 id="搜索数据"><a href="#搜索数据" class="headerlink" title="搜索数据"></a>搜索数据</h3><h4 id="根据id搜索数据"><a href="#根据id搜索数据" class="headerlink" title="根据id搜索数据"></a>根据id搜索数据</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /haoke/user/BbPe_WcB9cFOnF3uebvr</span><br><span class="line"><span class="comment">#返回的数据如下</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_index"</span>: <span class="string">"haoke"</span>,</span><br><span class="line">    <span class="string">"_type"</span>: <span class="string">"user"</span>,</span><br><span class="line">    <span class="string">"_id"</span>: <span class="string">"BbPe_WcB9cFOnF3uebvr"</span>,</span><br><span class="line">    <span class="string">"_version"</span>: 8,</span><br><span class="line">    <span class="string">"found"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"_source"</span>: &#123; <span class="comment">#原始数据在这里</span></span><br><span class="line">        <span class="string">"id"</span>: 1002,</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"李四"</span>,</span><br><span class="line">        <span class="string">"age"</span>: 40,</span><br><span class="line">        <span class="string">"sex"</span>: <span class="string">"男"</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125100452403.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h4 id="搜索全部数据"><a href="#搜索全部数据" class="headerlink" title="搜索全部数据"></a>搜索全部数据</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET  /haoke/user/_search</span><br></pre></td></tr></table></figure>

<p>注意，使用查询全部数据的时候，默认只会返回10条<br><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125100718456.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h4 id="关键字搜索数据"><a href="#关键字搜索数据" class="headerlink" title="关键字搜索数据"></a>关键字搜索数据</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询年龄等于20的用户</span></span><br><span class="line">GET /haoke/user/_search?q=age:20</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125100757807.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h3 id="DSL搜索"><a href="#DSL搜索" class="headerlink" title="DSL搜索"></a>DSL搜索</h3><p>Elasticsearch提供丰富且灵活的查询语言叫做DSL查询(Query DSL),它允许你构建更加复杂、强大的查询。<br>DSL(Domain Specific Language特定领域语言)以JSON请求体的形式出现。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /haoke/user/_search</span><br><span class="line"><span class="comment">#请求体</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span> : &#123;</span><br><span class="line">        <span class="string">"match"</span> : &#123; <span class="comment">#match只是查询的一种</span></span><br><span class="line">        	<span class="string">"age"</span> : 20</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125100930651.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>实现：查询年龄大于30岁的男性用户。<br>现有数据<br><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125101425163.png#pic_center" alt="在这里插入图片描述"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">POST /haoke/user/_search</span><br><span class="line"><span class="comment">#请求数据</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>: &#123;</span><br><span class="line">        <span class="string">"bool"</span>: &#123;</span><br><span class="line">            <span class="string">"filter"</span>: &#123;</span><br><span class="line">                    <span class="string">"range"</span>: &#123;</span><br><span class="line">                        <span class="string">"age"</span>: &#123;</span><br><span class="line">                        <span class="string">"gt"</span>: 30</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"must"</span>: &#123;</span><br><span class="line">                <span class="string">"match"</span>: &#123;</span><br><span class="line">                	<span class="string">"sex"</span>: <span class="string">"男"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询出来的结果</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125101556623.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h4 id="全文搜索"><a href="#全文搜索" class="headerlink" title="全文搜索"></a>全文搜索</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /haoke/user/_search</span><br><span class="line"><span class="comment">#请求数据</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>: &#123;</span><br><span class="line">        <span class="string">"match"</span>: &#123;</span><br><span class="line">        	<span class="string">"name"</span>: <span class="string">"张三 李四"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/2020112510531286.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>高亮显示，只需要在添加一个 highlight即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /haoke/user/_search</span><br><span class="line"><span class="comment">#请求数据</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>: &#123;</span><br><span class="line">        <span class="string">"match"</span>: &#123;</span><br><span class="line">        	<span class="string">"name"</span>: <span class="string">"张三 李四"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">"highlight"</span>: &#123;</span><br><span class="line">        <span class="string">"fields"</span>: &#123;</span><br><span class="line">        	<span class="string">"name"</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125105644776.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h4 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h4><p>在Elasticsearch中，支持聚合操作，类似SQL中的group by操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /haoke/user/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"aggs"</span>: &#123;</span><br><span class="line">        <span class="string">"all_interests"</span>: &#123;</span><br><span class="line">            <span class="string">"terms"</span>: &#123;</span><br><span class="line">                <span class="string">"field"</span>: <span class="string">"age"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果如下，我们通过年龄进行聚合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;took&quot;: 42,</span><br><span class="line">    &quot;timed_out&quot;: false,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 5,</span><br><span class="line">        &quot;successful&quot;: 5,</span><br><span class="line">        &quot;skipped&quot;: 0,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;hits&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 4,</span><br><span class="line">        &quot;max_score&quot;: 1,</span><br><span class="line">        &quot;hits&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;haoke&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;user&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;1001&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;id&quot;: 1001,</span><br><span class="line">                    &quot;name&quot;: &quot;张三&quot;,</span><br><span class="line">                    &quot;age&quot;: 40,</span><br><span class="line">                    &quot;sex&quot;: &quot;男&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;haoke&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;user&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;1002&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;id&quot;: 1002,</span><br><span class="line">                    &quot;name&quot;: &quot;王五&quot;,</span><br><span class="line">                    &quot;age&quot;: 40,</span><br><span class="line">                    &quot;sex&quot;: &quot;男&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;haoke&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;user&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;1003&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;query&quot;: &#123;</span><br><span class="line">                        &quot;bool&quot;: &#123;</span><br><span class="line">                            &quot;filter&quot;: &#123;</span><br><span class="line">                                &quot;range&quot;: &#123;</span><br><span class="line">                                    &quot;age&quot;: &#123;</span><br><span class="line">                                        &quot;gt&quot;: 30</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            &quot;must&quot;: &#123;</span><br><span class="line">                                &quot;match&quot;: &#123;</span><br><span class="line">                                    &quot;sex&quot;: &quot;男&quot;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;haoke&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;user&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;JKEK_XUBCDoY5aaarob7&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;id&quot;: 1002,</span><br><span class="line">                    &quot;name&quot;: &quot;李四&quot;,</span><br><span class="line">                    &quot;age&quot;: 21,</span><br><span class="line">                    &quot;sex&quot;: &quot;女&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;aggregations&quot;: &#123;</span><br><span class="line">        &quot;all_interests&quot;: &#123;</span><br><span class="line">            &quot;doc_count_error_upper_bound&quot;: 0,</span><br><span class="line">            &quot;sum_other_doc_count&quot;: 0,</span><br><span class="line">            &quot;buckets&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;key&quot;: 40,</span><br><span class="line">                    &quot;doc_count&quot;: 2</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;key&quot;: 21,</span><br><span class="line">                    &quot;doc_count&quot;: 1</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从结果可以看出，年龄30的有2条数据，20的有一条，40的一条。</p>
<h2 id="ElasticSearch核心详解"><a href="#ElasticSearch核心详解" class="headerlink" title="ElasticSearch核心详解"></a>ElasticSearch核心详解</h2><h3 id="文档-1"><a href="#文档-1" class="headerlink" title="文档"></a>文档</h3><p>在Elasticsearch中，文档以JSON格式进行存储，可以是复杂的结构，如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"_index"</span>: <span class="string">"haoke"</span>,</span><br><span class="line">    <span class="string">"_type"</span>: <span class="string">"user"</span>,</span><br><span class="line">    <span class="string">"_id"</span>: <span class="string">"1005"</span>,</span><br><span class="line">    <span class="string">"_version"</span>: 1,</span><br><span class="line">    <span class="string">"_score"</span>: 1,</span><br><span class="line">    <span class="string">"_source"</span>: &#123;</span><br><span class="line">        <span class="string">"id"</span>: 1005,</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"孙七"</span>,</span><br><span class="line">        <span class="string">"age"</span>: 37,</span><br><span class="line">        <span class="string">"sex"</span>: <span class="string">"女"</span>,</span><br><span class="line">        <span class="string">"card"</span>: &#123;</span><br><span class="line">            <span class="string">"card_number"</span>: <span class="string">"123456789"</span></span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，card是一个复杂对象，嵌套的Card对象</p>
<h4 id="元数据（metadata）"><a href="#元数据（metadata）" class="headerlink" title="元数据（metadata）"></a>元数据（metadata）</h4><p>一个文档不只有数据。它还包含了元数据(metadata)——关于文档的信息。三个必须的元数据节点是：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125150612355.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h4 id="index"><a href="#index" class="headerlink" title="index"></a>index</h4><p>索引(index)类似于关系型数据库里的“数据库”——它是我们存储和索引关联数据的地方。</p>
<blockquote>
<p>提示：事实上，我们的数据被存储和索引在分片(shards)中，索引只是一个把一个或多个分片分组在一起的逻辑空间。然而，这只是一些内部细节——我们的程序完全不用关心分片。对于我们的程序而言，文档存储在索引(index)中。剩下的细节由Elasticsearch关心既可。</p>
</blockquote>
<h4 id="type"><a href="#type" class="headerlink" title="_type"></a>_type</h4><p>在应用中，我们使用对象表示一些“事物”，例如一个用户、一篇博客、一个评论，或者一封邮件。每个对象都属于一个类(class)，这个类定义了属性或与对象关联的数据。user 类的对象可能包含姓名、性别、年龄和Email地址。<br>在关系型数据库中，我们经常将相同类的对象存储在一个表里，因为它们有着相同的结构。同理，在Elasticsearch<br>中，我们使用相同类型(type)的文档表示相同的“事物”，因为他们的数据结构也是相同的。</p>
<p>每个类型(type)都有自己的映射(mapping)或者结构定义，就像传统数据库表中的列一样。所有类型下的文档被存储在同一个索引下，但是类型的映射(mapping)会告诉Elasticsearch不同的文档如何被索引。</p>
<p>_type 的名字可以是大写或小写，不能包含下划线或逗号。我们将使用blog 做为类型名。</p>
<h4 id="id"><a href="#id" class="headerlink" title="_id"></a>_id</h4><p>id仅仅是一个字符串，它与_index 和_type 组合时，就可以在Elasticsearch中唯一标识一个文档。当创建一个文<br>档，你可以自定义_id ，也可以让Elasticsearch帮你自动生成（32位长度）</p>
<h3 id="查询响应"><a href="#查询响应" class="headerlink" title="查询响应"></a>查询响应</h3><h4 id="pretty"><a href="#pretty" class="headerlink" title="pretty"></a>pretty</h4><p>可以在查询url后面添加pretty参数，使得返回的json更易查看。</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125151124541.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h4 id="指定响应字段"><a href="#指定响应字段" class="headerlink" title="指定响应字段"></a>指定响应字段</h4><p>在响应的数据中，如果我们不需要全部的字段，可以指定某些需要的字段进行返回。通过添加 _source</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /haoke/user/1005?_source=id,name</span><br><span class="line"><span class="comment">#响应</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_index"</span>: <span class="string">"haoke"</span>,</span><br><span class="line">    <span class="string">"_type"</span>: <span class="string">"user"</span>,</span><br><span class="line">    <span class="string">"_id"</span>: <span class="string">"1005"</span>,</span><br><span class="line">    <span class="string">"_version"</span>: 1,</span><br><span class="line">    <span class="string">"found"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"_source"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"孙七"</span>,</span><br><span class="line">        <span class="string">"id"</span>: 1005</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125151619365.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>如不需要返回元数据，仅仅返回原始数据，可以这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /haoke/1 user/1005/_source</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125151819865.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>还可以这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /haoke/user/1005/_source?_source=id,name</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125152000414.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h4 id="判断文档是否存在"><a href="#判断文档是否存在" class="headerlink" title="判断文档是否存在"></a>判断文档是否存在</h4><p>如果我们只需要判断文档是否存在，而不是查询文档内容，那么可以这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HEAD /haoke/user/1005</span><br></pre></td></tr></table></figure>

<p>通过发送一个head请求，来判断数据是否存在</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125152247336.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HEAD 1 /haoke/user/1006</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125152256742.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<blockquote>
<p>当然，这只表示你在查询的那一刻文档不存在，但并不表示几毫秒后依旧不存在。另一个进程在这期间可能创建新文档。</p>
</blockquote>
<h3 id="批量操作"><a href="#批量操作" class="headerlink" title="批量操作"></a>批量操作</h3><p>有些情况下可以通过批量操作以减少网络请求。如：批量查询、批量插入数据。</p>
<h4 id="批量查询"><a href="#批量查询" class="headerlink" title="批量查询"></a>批量查询</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /haoke/user/_mget</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"ids"</span> : [ <span class="string">"1001"</span>, <span class="string">"1003"</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125152950940.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>如果，某一条数据不存在，不影响整体响应，需要通过found的值进行判断是否查询到数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /haoke/user/_mget</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"ids"</span> : [ <span class="string">"1001"</span>, <span class="string">"1006"</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125153034320.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<blockquote>
<p>也就是说，一个数据的存在不会影响其它数据的返回</p>
</blockquote>
<h4 id="bulk操作"><a href="#bulk操作" class="headerlink" title="_bulk操作"></a>_bulk操作</h4><p>在Elasticsearch中，支持批量的插入、修改、删除操作，都是通过_bulk的api完成的。</p>
<p>请求格式如下：（请求格式不同寻常）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123; action: &#123; metadata &#125;&#125;</span><br><span class="line">&#123; request body &#125;</span><br><span class="line">&#123; action: &#123; metadata &#125;&#125;</span><br><span class="line">&#123; request body &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>批量插入数据： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"create"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"haoke"</span>,<span class="string">"_type"</span>:<span class="string">"user"</span>,<span class="string">"_id"</span>:2001&#125;&#125;</span><br><span class="line">&#123;<span class="string">"id"</span>:2001,<span class="string">"name"</span>:<span class="string">"name1"</span>,<span class="string">"age"</span>: 20,<span class="string">"sex"</span>: <span class="string">"男"</span>&#125;</span><br><span class="line">&#123;<span class="string">"create"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"haoke"</span>,<span class="string">"_type"</span>:<span class="string">"user"</span>,<span class="string">"_id"</span>:2002&#125;&#125;</span><br><span class="line">&#123;<span class="string">"id"</span>:2002,<span class="string">"name"</span>:<span class="string">"name2"</span>,<span class="string">"age"</span>: 20,<span class="string">"sex"</span>: <span class="string">"男"</span>&#125;</span><br><span class="line">&#123;<span class="string">"create"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"haoke"</span>,<span class="string">"_type"</span>:<span class="string">"user"</span>,<span class="string">"_id"</span>:2003&#125;&#125;</span><br><span class="line">&#123;<span class="string">"id"</span>:2003,<span class="string">"name"</span>:<span class="string">"name3"</span>,<span class="string">"age"</span>: 20,<span class="string">"sex"</span>: <span class="string">"男"</span>&#125;</span><br></pre></td></tr></table></figure>

<p>==注意最后一行的回车==。</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125153550976.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>批量删除：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"delete"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"haoke"</span>,<span class="string">"_type"</span>:<span class="string">"user"</span>,<span class="string">"_id"</span>:2001&#125;&#125;</span><br><span class="line">&#123;<span class="string">"delete"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"haoke"</span>,<span class="string">"_type"</span>:<span class="string">"user"</span>,<span class="string">"_id"</span>:2002&#125;&#125;</span><br><span class="line">&#123;<span class="string">"delete"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"haoke"</span>,<span class="string">"_type"</span>:<span class="string">"user"</span>,<span class="string">"_id"</span>:2003&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>由于delete没有请求体，所以，action的下一行直接就是下一个action。</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125153704983.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>其他操作就类似了。一次请求多少性能最高？</p>
<ul>
<li>整个批量请求需要被加载到接受我们请求节点的内存里，所以请求越大，给其它请求可用的内存就越小。有一<br>个最佳的bulk请求大小。超过这个大小，性能不再提升而且可能降低。</li>
<li>最佳大小，当然并不是一个固定的数字。它完全取决于你的硬件、你文档的大小和复杂度以及索引和搜索的负<br>载。</li>
<li>幸运的是，这个最佳点(sweetspot)还是容易找到的：试着批量索引标准的文档，随着大小的增长，当性能开始<br>降低，说明你每个批次的大小太大了。开始的数量可以在1000~5000个文档之间，如果你的文档非常大，可以使用较小的批次。</li>
<li>通常着眼于你请求批次的物理大小是非常有用的。一千个1kB的文档和一千个1MB的文档大不相同。一个好的<br>批次最好保持在5-15MB大小间。</li>
</ul>
<h3 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h3><p>和SQL使用LIMIT 关键字返回只有一页的结果一样，Elasticsearch接受from 和size 参数：</p>
<ul>
<li>size: 结果数，默认10</li>
<li>from: 跳过开始的结果数，默认0</li>
</ul>
<p>如果你想每页显示5个结果，页码从1到3，那请求如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /_search?size=5</span><br><span class="line">GET /_search?size=5&amp;from=5</span><br><span class="line">GET /_search?size=5&amp;from=10</span><br></pre></td></tr></table></figure>

<p>应该当心分页太深或者一次请求太多的结果。结果在返回前会被排序。但是记住一个搜索请求常常涉及多个分<br>片。每个分片生成自己排好序的结果，它们接着需要集中起来排序以确保整体排序正确。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /haoke/user/_1 search?size=1&amp;from=3</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125154318731.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h4 id="在集群系统中深度分页"><a href="#在集群系统中深度分页" class="headerlink" title="在集群系统中深度分页"></a>在集群系统中深度分页</h4><p>为了理解为什么深度分页是有问题的，让我们假设在一个有5个主分片的索引中搜索。当我们请求结果的第一<br>页（结果1到10）时，每个分片产生自己最顶端10个结果然后返回它们给请求节点(requesting node)，它再<br>排序这所有的50个结果以选出顶端的10个结果。</p>
<p>现在假设我们请求第1000页——结果10001到10010。工作方式都相同，不同的是每个分片都必须产生顶端的<br>10010个结果。然后请求节点排序这50050个结果并丢弃50040个！</p>
<p>你可以看到在分布式系统中，排序结果的花费随着分页的深入而成倍增长。这也是为什么网络搜索引擎中任何<br>语句不能返回多于1000个结果的原因。</p>
<h3 id="映射-1"><a href="#映射-1" class="headerlink" title="映射"></a>映射</h3><p>前面我们创建的索引以及插入数据，都是由Elasticsearch进行自动判断类型，有些时候我们是需要进行明确字段类型的，否则，自动判断的类型和实际需求是不相符的。</p>
<p>自动判断的规则如下：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125155655136.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>Elasticsearch中支持的类型如下：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125155707598.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<ul>
<li>string类型在ElasticSearch 旧版本中使用较多，从ElasticSearch 5.x开始不再支持string，由text和<br>keyword类型替代。</li>
<li>text 类型，当一个字段是要被全文搜索的，比如Email内容、产品描述，应该使用text类型。设置text类型<br>以后，字段内容会被分析，在生成倒排索引以前，字符串会被分析器分成一个一个词项。text类型的字段<br>不用于排序，很少用于聚合。</li>
<li>keyword类型适用于索引结构化的字段，比如email地址、主机名、状态码和标签。如果字段需要进行过<br>滤(比如查找已发布博客中status属性为published的文章)、排序、聚合。keyword类型的字段只能通过精<br>确值搜索到。</li>
</ul>
<h4 id="创建明确类型的索引："><a href="#创建明确类型的索引：" class="headerlink" title="创建明确类型的索引："></a>创建明确类型的索引：</h4><blockquote>
<p> 如果你要像之前旧版版本一样兼容自定义 type ,需要将 *<em>i*</em>nclude_type_name=true 携带</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">put http://202.193.56.222:9200/itcast?include_type_name=<span class="literal">true</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"settings"</span>:&#123;</span><br><span class="line">        <span class="string">"index"</span>:&#123;</span><br><span class="line">            <span class="string">"number_of_shards"</span>:<span class="string">"2"</span>,</span><br><span class="line">            <span class="string">"number_of_replicas"</span>:<span class="string">"0"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"mappings"</span>:&#123;</span><br><span class="line">        <span class="string">"person"</span>:&#123;</span><br><span class="line">            <span class="string">"properties"</span>:&#123;</span><br><span class="line">                <span class="string">"name"</span>:&#123;</span><br><span class="line">                    <span class="string">"type"</span>:<span class="string">"text"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"age"</span>:&#123;</span><br><span class="line">                    <span class="string">"type"</span>:<span class="string">"integer"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"mail"</span>:&#123;</span><br><span class="line">                    <span class="string">"type"</span>:<span class="string">"keyword"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"hobby"</span>:&#123;</span><br><span class="line">                    <span class="string">"type"</span>:<span class="string">"text"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看映射</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /itcast/_mapping</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125160951910.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>插入数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST /itcast/_bulk</span><br><span class="line">&#123;<span class="string">"index"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"itcast"</span>,<span class="string">"_type"</span>:<span class="string">"person"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"name"</span>:<span class="string">"张三"</span>,<span class="string">"age"</span>: 20,<span class="string">"mail"</span>: <span class="string">"111@qq.com"</span>,<span class="string">"hobby"</span>:<span class="string">"羽毛球、乒乓球、足球"</span>&#125;</span><br><span class="line">&#123;<span class="string">"index"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"itcast"</span>,<span class="string">"_type"</span>:<span class="string">"person"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"name"</span>:<span class="string">"李四"</span>,<span class="string">"age"</span>: 21,<span class="string">"mail"</span>: <span class="string">"222@qq.com"</span>,<span class="string">"hobby"</span>:<span class="string">"羽毛球、乒乓球、足球、篮球"</span>&#125;</span><br><span class="line">&#123;<span class="string">"index"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"itcast"</span>,<span class="string">"_type"</span>:<span class="string">"person"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"name"</span>:<span class="string">"王五"</span>,<span class="string">"age"</span>: 22,<span class="string">"mail"</span>: <span class="string">"333@qq.com"</span>,<span class="string">"hobby"</span>:<span class="string">"羽毛球、篮球、游泳、听音乐"</span>&#125;</span><br><span class="line">&#123;<span class="string">"index"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"itcast"</span>,<span class="string">"_type"</span>:<span class="string">"person"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"name"</span>:<span class="string">"赵六"</span>,<span class="string">"age"</span>: 23,<span class="string">"mail"</span>: <span class="string">"444@qq.com"</span>,<span class="string">"hobby"</span>:<span class="string">"跑步、游泳"</span>&#125;</span><br><span class="line">&#123;<span class="string">"index"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"itcast"</span>,<span class="string">"_type"</span>:<span class="string">"person"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"name"</span>:<span class="string">"孙七"</span>,<span class="string">"age"</span>: 24,<span class="string">"mail"</span>: <span class="string">"555@qq.com"</span>,<span class="string">"hobby"</span>:<span class="string">"听音乐、看电影"</span>&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/2020112516110582.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h4 id="测试搜索"><a href="#测试搜索" class="headerlink" title="测试搜索"></a>测试搜索</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /itcast/person/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>:&#123;</span><br><span class="line">        <span class="string">"match"</span>:&#123;</span><br><span class="line">            <span class="string">"hobby"</span>:<span class="string">"音乐"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125161145561.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h3 id="结构化查询"><a href="#结构化查询" class="headerlink" title="结构化查询"></a>结构化查询</h3><h4 id="term查询"><a href="#term查询" class="headerlink" title="term查询"></a>term查询</h4><p>term 主要用于精确匹配哪些值，比如数字，日期，布尔值或 not_analyzed 的字符串(未经分析的文本数据类型)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="string">"term"</span>: &#123; <span class="string">"age"</span>: 26 &#125;&#125;</span><br><span class="line">&#123; <span class="string">"term"</span>: &#123; <span class="string">"date"</span>: <span class="string">"2014-09-01"</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">"term"</span>: &#123; <span class="string">"public"</span>: <span class="literal">true</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">"term"</span>: &#123; <span class="string">"tag"</span>: <span class="string">"full_text"</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /itcast/person/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>:&#123;</span><br><span class="line">        <span class="string">"term"</span>:&#123;</span><br><span class="line">            <span class="string">"age"</span>:20</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/2020112516195378.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h4 id="terms查询"><a href="#terms查询" class="headerlink" title="terms查询"></a>terms查询</h4><p>terms 跟 term 有点类似，但 terms 允许指定多个匹配条件。 如果某个字段指定了多个值，那么文档需要一起去<br>做匹配：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"terms"</span>:&#123;</span><br><span class="line">        <span class="string">"tag"</span>:[</span><br><span class="line">            <span class="string">"search"</span>,</span><br><span class="line">            <span class="string">"full_text"</span>,</span><br><span class="line">            <span class="string">"nosql"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST /itcast/person/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>:&#123;</span><br><span class="line">        <span class="string">"terms"</span>:&#123;</span><br><span class="line">            <span class="string">"age"</span>:[</span><br><span class="line">                20,</span><br><span class="line">                21</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125162444705.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h4 id="range查询"><a href="#range查询" class="headerlink" title="range查询"></a>range查询</h4><p>range 过滤允许我们按照指定范围查找一批数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"range"</span>:&#123;</span><br><span class="line">        <span class="string">"age"</span>:&#123;</span><br><span class="line">            <span class="string">"gte"</span>:20,</span><br><span class="line">            <span class="string">"lt"</span>:30</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范围操作符包含：</p>
<ul>
<li>gt : 大于</li>
<li>gte:: 大于等于</li>
<li>lt : 小于</li>
<li>lte: 小于等于</li>
</ul>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST /itcast/person/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>:&#123;</span><br><span class="line">        <span class="string">"range"</span>:&#123;</span><br><span class="line">            <span class="string">"age"</span>:&#123;</span><br><span class="line">                <span class="string">"gte"</span>:20,</span><br><span class="line">                <span class="string">"lte"</span>:22</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125162741744.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h4 id="exists-查询"><a href="#exists-查询" class="headerlink" title="exists 查询"></a>exists 查询</h4><p>exists 查询可以用于查找文档中是否包含指定字段或没有某个字段，类似于SQL语句中的IS_NULL 条件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"exists"</span>: &#123;</span><br><span class="line">    	<span class="string">"field"</span>: <span class="string">"title"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两个查询只是针对已经查出一批数据来，但是想区分出某个字段是否存在的时候使用。示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /haoke/user/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>: &#123;</span><br><span class="line">        <span class="string">"exists"</span>: &#123; <span class="comment">#必须包含</span></span><br><span class="line">        	<span class="string">"field"</span>: <span class="string">"card"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125162903616.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125162928482.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h4 id="match查询"><a href="#match查询" class="headerlink" title="match查询"></a>match查询</h4><p>match 查询是一个标准查询，不管你需要全文本查询还是精确查询基本上都要用到它。</p>
<p>如果你使用 match 查询一个全文本字段，它会在真正查询之前用分析器先分析match 一下查询字符：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"match"</span>: &#123;</span><br><span class="line">    	<span class="string">"tweet"</span>: <span class="string">"About Search"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果用match 下指定了一个确切值，在遇到数字，日期，布尔值或者not_analyzed 的字符串时，它将为你搜索你<br>给定的值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="string">"match"</span>: &#123; <span class="string">"age"</span>: 26 &#125;&#125;</span><br><span class="line">&#123; <span class="string">"match"</span>: &#123; <span class="string">"date"</span>: <span class="string">"2014-09-01"</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">"match"</span>: &#123; <span class="string">"public"</span>: <span class="literal">true</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">"match"</span>: &#123; <span class="string">"tag"</span>: <span class="string">"full_text"</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="bool查询"><a href="#bool查询" class="headerlink" title="bool查询"></a>bool查询</h4><ul>
<li>bool 查询可以用来合并多个条件查询结果的布尔逻辑，它包含一下操作符：</li>
<li>must :: 多个查询条件的完全匹配,相当于 and 。</li>
<li>must_not :: 多个查询条件的相反匹配，相当于 not 。</li>
<li>should :: 至少有一个查询条件匹配, 相当于 or 。</li>
</ul>
<p>这些参数可以分别继承一个查询条件或者一个查询条件的数组：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"bool"</span>:&#123;</span><br><span class="line">        <span class="string">"must"</span>:&#123;</span><br><span class="line">            <span class="string">"term"</span>:&#123;</span><br><span class="line">                <span class="string">"folder"</span>:<span class="string">"inbox"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"must_not"</span>:&#123;</span><br><span class="line">            <span class="string">"term"</span>:&#123;</span><br><span class="line">                <span class="string">"tag"</span>:<span class="string">"spam"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"should"</span>:[</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"term"</span>:&#123;</span><br><span class="line">                    <span class="string">"starred"</span>:<span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"term"</span>:&#123;</span><br><span class="line">                    <span class="string">"unread"</span>:<span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">"query"</span>:&#123;</span><br><span class="line">    <span class="string">"bool"</span>:&#123;</span><br><span class="line">        <span class="string">"must"</span>:&#123;</span><br><span class="line">            <span class="string">"match"</span>:&#123;</span><br><span class="line">                <span class="string">"hobby"</span>:<span class="string">"足球"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"must_not"</span>:&#123;</span><br><span class="line">            <span class="string">"match"</span>:&#123;</span><br><span class="line">                <span class="string">"hobby"</span>:<span class="string">"音乐"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125163819486.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h3 id="过滤查询"><a href="#过滤查询" class="headerlink" title="过滤查询"></a>过滤查询</h3><p>前面讲过结构化查询，Elasticsearch也支持过滤查询，如term、range、match等。</p>
<p>示例：查询年龄为20岁的用户。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /itcast/person/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>:&#123;</span><br><span class="line">        <span class="string">"bool"</span>:&#123;</span><br><span class="line">            <span class="string">"filter"</span>:&#123;</span><br><span class="line">                <span class="string">"term"</span>:&#123;</span><br><span class="line">                    <span class="string">"age"</span>:20</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125164120698.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h4 id="查询和过滤的对比"><a href="#查询和过滤的对比" class="headerlink" title="查询和过滤的对比"></a>查询和过滤的对比</h4><ul>
<li>一条过滤语句会询问每个文档的字段值是否包含着特定值。</li>
<li>查询语句会询问每个文档的字段值与特定值的匹配程度如何。</li>
<li>一条查询语句会计算每个文档与查询语句的相关性，会给出一个相关性评分 _score，并且 按照相关性对匹<br>配到的文档进行排序。 这种评分方式非常适用于一个没有完全配置结果的全文本搜索。</li>
<li>一个简单的文档列表，快速匹配运算并存入内存是十分方便的， 每个文档仅需要1个字节。这些缓存的过滤结果集与后续请求的结合使用是非常高效的。</li>
<li>查询语句不仅要查找相匹配的文档，还需要计算每个文档的相关性，所以一般来说查询语句要比 过滤语句更耗时，并且查询结果也不可缓存。</li>
</ul>
<h4 id="建议："><a href="#建议：" class="headerlink" title="建议："></a>建议：</h4><p>做精确匹配搜索时，最好用过滤语句，因为过滤语句可以缓存数据。</p>
<h2 id="中文分词"><a href="#中文分词" class="headerlink" title="中文分词"></a>中文分词</h2><h3 id="什么是分词"><a href="#什么是分词" class="headerlink" title="什么是分词"></a>什么是分词</h3><p>分词就是指将一个文本转化成一系列单词的过程，也叫文本分析，在Elasticsearch中称之为Analysis。</p>
<p>举例：我是中国人 –&gt; 我/是/中国人</p>
<h3 id="分词api"><a href="#分词api" class="headerlink" title="分词api"></a>分词api</h3><p>指定分词器进行分词</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /_analyze</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"analyzer"</span>:<span class="string">"standard"</span>,</span><br><span class="line">    <span class="string">"text"</span>:<span class="string">"hello world"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果如下</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125165344199.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>在结果中不仅可以看出分词的结果，还返回了该词在文本中的位置。</p>
<blockquote>
<p>指定索引分词</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /itcast/_analyze</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"analyzer"</span>: <span class="string">"standard"</span>,</span><br><span class="line">    <span class="string">"field"</span>: <span class="string">"hobby"</span>,</span><br><span class="line">    <span class="string">"text"</span>: <span class="string">"听音乐"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201125165641133.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h3 id="中文分词难点"><a href="#中文分词难点" class="headerlink" title="中文分词难点"></a>中文分词难点</h3><p>中文分词的难点在于，在汉语中没有明显的词汇分界点，如在英语中，空格可以作为分隔符，如果分隔不正确就会造成歧义。如：</p>
<ul>
<li>我/爱/炒肉丝</li>
<li>我/爱/炒/肉丝</li>
</ul>
<p>常用中文分词器，IK、jieba、THULAC等，推荐使用IK分词器。</p>
<p>IK Analyzer是一个开源的，基于java语言开发的轻量级的中文分词工具包。从2006年12月推出1.0版开始，IKAnalyzer已经推出了3个大版本。最初，它是以开源项目Luence为应用主体的，结合词典分词和文法分析算法的中文分词组件。新版本的IK Analyzer 3.0则发展为面向Java的公用分词组件，独立于Lucene项目，同时提供了对Lucene的默认优化实现。</p>
<p>采用了特有的“正向迭代最细粒度切分算法“，具有80万字/秒的高速处理能力 采用了多子处理器分析模式，支持：英文字母（IP地址、Email、URL）、数字（日期，常用中文数量词，罗马数字，科学计数法），中文词汇（姓名、地名处理）等分词处理。 优化的词典存储，更小的内存占用。</p>
<p>IK分词器 Elasticsearch插件地址：<a href="https://github.com/medcl/elasticsearch-analysis-ik" target="_blank" rel="noopener">https://github.com/medcl/elasticsearch-analysis-ik</a><br><a href="https://www.cnblogs.com/szwdun/p/10664348.html" target="_blank" rel="noopener">docker安装IK分词器</a></p>
<h3 id="安装分词器"><a href="#安装分词器" class="headerlink" title="安装分词器"></a>安装分词器</h3><p><a href="https://www.cnblogs.com/szwdun/p/10664348.html" target="_blank" rel="noopener"> docker安装IK分词器</a><br>首先下载到最新的ik分词器：<a href="https://github.com/medcl/elasticsearch-analysis-ik/releases/tag/v7.9.1" target="_blank" rel="noopener">下载地址</a></p>
<p>下载完成后，使用xftp工具，拷贝到服务器上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装方法：将下载到的 es/plugins/ik 目录下</span></span><br><span class="line">mkdir es/plugins/ik</span><br><span class="line"></span><br><span class="line"><span class="comment">#解压</span></span><br><span class="line">unzip elasticsearch-analysis-ik-7.9.1.zip</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启</span></span><br><span class="line">./bin/elasticsearch</span><br></pre></td></tr></table></figure>

<p>我们通过日志，发现它已经成功加载了ik分词器插件</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126095112125.png#pic_center" alt="在这里插入图片描述"></p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /_analyze</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"analyzer"</span>: <span class="string">"ik_max_word"</span>,</span><br><span class="line">    <span class="string">"text"</span>: <span class="string">"我是中国人"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们发现ik分词器已经成功分词完成</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126095026422.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2 id="全文搜索-1"><a href="#全文搜索-1" class="headerlink" title="全文搜索"></a>全文搜索</h2><p>全文搜索两个最重要的方面是：</p>
<ul>
<li>相关性（Relevance） 它是评价查询与其结果间的相关程度，并根据这种相关程度对结果排名的一种能力，这<br>种计算方式可以是 TF/IDF 方法、地理位置邻近、模糊相似，或其他的某些算法。</li>
<li>分词（Analysis） 它是将文本块转换为有区别的、规范化的 token 的一个过程，目的是为了创建倒排索引以及查询倒排索引。</li>
</ul>
<h3 id="构造数据"><a href="#构造数据" class="headerlink" title="构造数据"></a>构造数据</h3><blockquote>
<p>ES 7.4 默认不在支持指定索引类型，默认索引类型是_doc</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PUT http://202.193.56.222:9200/itcast</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"settings"</span>:&#123;</span><br><span class="line">        <span class="string">"index"</span>:&#123;</span><br><span class="line">            <span class="string">"number_of_shards"</span>:<span class="string">"1"</span>,</span><br><span class="line">            <span class="string">"number_of_replicas"</span>:<span class="string">"0"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"mappings"</span>:&#123;</span><br><span class="line">        <span class="string">"person"</span>:&#123;</span><br><span class="line">            <span class="string">"properties"</span>:&#123;</span><br><span class="line">                <span class="string">"name"</span>:&#123;</span><br><span class="line">                    <span class="string">"type"</span>:<span class="string">"text"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"age"</span>:&#123;</span><br><span class="line">                    <span class="string">"type"</span>:<span class="string">"integer"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"mail"</span>:&#123;</span><br><span class="line">                    <span class="string">"type"</span>:<span class="string">"keyword"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"hobby"</span>:&#123;</span><br><span class="line">                    <span class="string">"type"</span>:<span class="string">"text"</span>,</span><br><span class="line">                    <span class="string">"analyzer"</span>:<span class="string">"ik_max_word"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后插入数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST http://202.193.56.222:9200/itcast/_bulk</span><br><span class="line">&#123;<span class="string">"index"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"itcast"</span>,<span class="string">"_type"</span>:<span class="string">"person"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"name"</span>:<span class="string">"张三"</span>,<span class="string">"age"</span>: 20,<span class="string">"mail"</span>: <span class="string">"111@qq.com"</span>,<span class="string">"hobby"</span>:<span class="string">"羽毛球、乒乓球、足球"</span>&#125;</span><br><span class="line">&#123;<span class="string">"index"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"itcast"</span>,<span class="string">"_type"</span>:<span class="string">"person"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"name"</span>:<span class="string">"李四"</span>,<span class="string">"age"</span>: 21,<span class="string">"mail"</span>: <span class="string">"222@qq.com"</span>,<span class="string">"hobby"</span>:<span class="string">"羽毛球、乒乓球、足球、篮球"</span>&#125;</span><br><span class="line">&#123;<span class="string">"index"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"itcast"</span>,<span class="string">"_type"</span>:<span class="string">"person"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"name"</span>:<span class="string">"王五"</span>,<span class="string">"age"</span>: 22,<span class="string">"mail"</span>: <span class="string">"333@qq.com"</span>,<span class="string">"hobby"</span>:<span class="string">"羽毛球、篮球、游泳、听音乐"</span>&#125;</span><br><span class="line">&#123;<span class="string">"index"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"itcast"</span>,<span class="string">"_type"</span>:<span class="string">"person"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"name"</span>:<span class="string">"赵六"</span>,<span class="string">"age"</span>: 23,<span class="string">"mail"</span>: <span class="string">"444@qq.com"</span>,<span class="string">"hobby"</span>:<span class="string">"跑步、游泳、篮球"</span>&#125;</span><br><span class="line">&#123;<span class="string">"index"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"itcast"</span>,<span class="string">"_type"</span>:<span class="string">"person"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"name"</span>:<span class="string">"孙七"</span>,<span class="string">"age"</span>: 24,<span class="string">"mail"</span>: <span class="string">"555@qq.com"</span>,<span class="string">"hobby"</span>:<span class="string">"听音乐、看电影、羽毛球"</span>&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126100037396.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h3 id="单词搜索"><a href="#单词搜索" class="headerlink" title="单词搜索"></a>单词搜索</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /itcast/person/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>:&#123;</span><br><span class="line">        <span class="string">"match"</span>:&#123;</span><br><span class="line">            <span class="string">"hobby"</span>:<span class="string">"音乐"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"highlight"</span>:&#123;</span><br><span class="line">        <span class="string">"fields"</span>:&#123;</span><br><span class="line">            <span class="string">"hobby"</span>:&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询出来的结果如下，并且还带有高亮</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126100202627.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>过程说明：</p>
<ul>
<li>检查字段类型<ul>
<li>爱好 hobby 字段是一个 text 类型（ 指定了IK分词器），这意味着查询字符串本身也应该被分词。</li>
</ul>
</li>
<li>分析查询字符串 。<ul>
<li>将查询的字符串 “音乐” 传入IK分词器中，输出的结果是单个项 音乐。因为只有一个单词项，所以 match 查询执行的是单个底层 term 查询。</li>
</ul>
</li>
<li>查找匹配文档 。<ul>
<li>用 term 查询在倒排索引中查找 “音乐” 然后获取一组包含该项的文档，本例的结果是文档：3 、5 。</li>
</ul>
</li>
<li>为每个文档评分 。<ul>
<li>用 term 查询计算每个文档相关度评分 _score ，这是种将 词频（term frequency，即词 “音乐” 在相关文档的hobby 字段中出现的频率）和 反向文档频率（inverse document frequency，即词 “音乐” 在所有文档的hobby 字段中出现的频率），以及字段的长度（即字段越短相关度越高）相结合的计算方式。</li>
</ul>
</li>
</ul>
<h3 id="多词搜索"><a href="#多词搜索" class="headerlink" title="多词搜索"></a>多词搜索</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /itcast/person/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>:&#123;</span><br><span class="line">        <span class="string">"match"</span>:&#123;</span><br><span class="line">            <span class="string">"hobby"</span>:<span class="string">"音乐 篮球"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"highlight"</span>:&#123;</span><br><span class="line">        <span class="string">"fields"</span>:&#123;</span><br><span class="line">            <span class="string">"hobby"</span>:&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，包含了“音乐”、“篮球”的数据都已经被搜索到了。可是，搜索的结果并不符合我们的预期，因为我们想搜索的是既包含“音乐”又包含“篮球”的用户，显然结果返回的“或”的关系。在Elasticsearch中，可以指定词之间的逻辑关系，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST /itcast/person/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>:&#123;</span><br><span class="line">        <span class="string">"match"</span>:&#123;</span><br><span class="line">            <span class="string">"hobby"</span>:&#123;</span><br><span class="line">            	<span class="string">"operator"</span>:<span class="string">"and"</span>,</span><br><span class="line">            	<span class="string">"query"</span>: <span class="string">"音乐 篮球"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"highlight"</span>:&#123;</span><br><span class="line">        <span class="string">"fields"</span>:&#123;</span><br><span class="line">            <span class="string">"hobby"</span>:&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过这样的话，就会让两个关键字之间存在and关系了</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126102143796.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>可以看到结果符合预期。</p>
<p>前面我们测试了“OR” 和 “AND”搜索，这是两个极端，其实在实际场景中，并不会选取这2个极端，更有可能是选取这种，或者说，只需要符合一定的相似度就可以查询到数据，在Elasticsearch中也支持这样的查询，通过<br>minimum_should_match来指定匹配度，如：70%；</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>:&#123;</span><br><span class="line">        <span class="string">"match"</span>:&#123;</span><br><span class="line">            <span class="string">"hobby"</span>:&#123;</span><br><span class="line">            <span class="string">"minimum_should_match"</span>:<span class="string">"80%"</span>,</span><br><span class="line">            	<span class="string">"query"</span>: <span class="string">"游泳 羽毛球"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"highlight"</span>:&#123;</span><br><span class="line">        <span class="string">"fields"</span>:&#123;</span><br><span class="line">            <span class="string">"hobby"</span>:&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#结果：省略显示</span></span><br><span class="line"><span class="string">"hits"</span>: &#123;</span><br><span class="line"><span class="string">"total"</span>: 4, <span class="comment">#相似度为80%的情况下，查询到4条数据</span></span><br><span class="line"><span class="string">"max_score"</span>: 1.621458,</span><br><span class="line"><span class="string">"hits"</span>: [</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#设置40%进行测试：</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>:&#123;</span><br><span class="line">        <span class="string">"match"</span>:&#123;</span><br><span class="line">            <span class="string">"hobby"</span>:&#123;</span><br><span class="line">            <span class="string">"query"</span>:<span class="string">"游泳 羽毛球"</span>,</span><br><span class="line">            <span class="string">"minimum_should_match"</span>:<span class="string">"40%"</span></span><br><span class="line">            &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"highlight"</span>: &#123;</span><br><span class="line">            <span class="string">"fields"</span>: &#123;</span><br><span class="line">            <span class="string">"hobby"</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#结果：</span></span><br><span class="line"><span class="string">"hits"</span>: &#123;</span><br><span class="line"><span class="string">"total"</span>: 5, <span class="comment">#相似度为40%的情况下，查询到5条数据</span></span><br><span class="line"><span class="string">"max_score"</span>: 1.621458,</span><br><span class="line"><span class="string">"hits"</span>: [</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相似度应该多少合适，需要在实际的需求中进行反复测试，才可得到合理的值。</p>
<h3 id="组合搜索"><a href="#组合搜索" class="headerlink" title="组合搜索"></a>组合搜索</h3><p>在搜索时，也可以使用过滤器中讲过的bool组合查询，示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">POST /itcast/person/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>:&#123;</span><br><span class="line">        <span class="string">"bool"</span>:&#123;</span><br><span class="line">            <span class="string">"must"</span>:&#123;</span><br><span class="line">                <span class="string">"match"</span>:&#123;</span><br><span class="line">                    <span class="string">"hobby"</span>:<span class="string">"篮球"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"must_not"</span>:&#123;</span><br><span class="line">                <span class="string">"match"</span>:&#123;</span><br><span class="line">                    <span class="string">"hobby"</span>:<span class="string">"音乐"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"should"</span>:[</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"match"</span>:&#123;</span><br><span class="line">                        <span class="string">"hobby"</span>:<span class="string">"游泳"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"highlight"</span>:&#123;</span><br><span class="line">        <span class="string">"fields"</span>:&#123;</span><br><span class="line">            <span class="string">"hobby"</span>:&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面搜索的意思是：<br>搜索结果中必须包含篮球，不能包含音乐，如果包含了游泳，那么它的相似度更高。</p>
</blockquote>
<p>结果：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126110142313.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<blockquote>
<p>评分的计算规则</p>
<p>bool 查询会为每个文档计算相关度评分 _score ， 再将所有匹配的 must 和 should 语句的分数 _score 求和，最后除以 must 和 should 语句的总数。</p>
<p>must_not 语句不会影响评分； 它的作用只是将不相关的文档排除。</p>
</blockquote>
<p>默认情况下，should中的内容不是必须匹配的，如果查询语句中没有must，那么就会至少匹配其中一个。当然了，也可以通过minimum_should_match参数进行控制，该值可以是数字也可以的百分比。</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">POST /itcast/person/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>:&#123;</span><br><span class="line">        <span class="string">"bool"</span>:&#123;</span><br><span class="line">            <span class="string">"should"</span>:[</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"match"</span>:&#123;</span><br><span class="line">                        <span class="string">"hobby"</span>:<span class="string">"游泳"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"match"</span>:&#123;</span><br><span class="line">                        <span class="string">"hobby"</span>:<span class="string">"篮球"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"match"</span>:&#123;</span><br><span class="line">                        <span class="string">"hobby"</span>:<span class="string">"音乐"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">"minimum_should_match"</span>:2</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"highlight"</span>:&#123;</span><br><span class="line">        <span class="string">"fields"</span>:&#123;</span><br><span class="line">            <span class="string">"hobby"</span>:&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>minimum_should_match为2，意思是should中的三个词，至少要满足2个。</p>
<h3 id="权重"><a href="#权重" class="headerlink" title="权重"></a>权重</h3><p>有些时候，我们可能需要对某些词增加权重来影响该条数据的得分。如下：</p>
<p>搜索关键字为“游泳篮球”，如果结果中包含了“音乐”权重为10，包含了“跑步”权重为2。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">POST /itcast/person/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>:&#123;</span><br><span class="line">        <span class="string">"bool"</span>:&#123;</span><br><span class="line">            <span class="string">"must"</span>:&#123;</span><br><span class="line">                <span class="string">"match"</span>:&#123;</span><br><span class="line">                    <span class="string">"hobby"</span>:&#123;</span><br><span class="line">                        <span class="string">"query"</span>:<span class="string">"游泳篮球"</span>,</span><br><span class="line">                        <span class="string">"operator"</span>:<span class="string">"and"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"should"</span>:[</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"match"</span>:&#123;</span><br><span class="line">                        <span class="string">"hobby"</span>:&#123;</span><br><span class="line">                            <span class="string">"query"</span>:<span class="string">"音乐"</span>,</span><br><span class="line">                            <span class="string">"boost"</span>:10</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"match"</span>:&#123;</span><br><span class="line">                        <span class="string">"hobby"</span>:&#123;</span><br><span class="line">                            <span class="string">"query"</span>:<span class="string">"跑步"</span>,</span><br><span class="line">                            <span class="string">"boost"</span>:2</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"highlight"</span>:&#123;</span><br><span class="line">        <span class="string">"fields"</span>:&#123;</span><br><span class="line">            <span class="string">"hobby"</span>:&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126110218226.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2 id="ElasticSearch集群"><a href="#ElasticSearch集群" class="headerlink" title="ElasticSearch集群"></a>ElasticSearch集群</h2><h3 id="集群节点"><a href="#集群节点" class="headerlink" title="集群节点"></a>集群节点</h3><p>ELasticsearch的集群是由多个节点组成的，通过cluster.name设置集群名称，并且用于区分其它的集群，每个节点通过node.name指定节点的名称。</p>
<p>在Elasticsearch中，节点的类型主要有4种：</p>
<ul>
<li>master节点<ul>
<li>配置文件中node.master属性为true(默认为true)，就有资格被选为master节点。master节点用于控制整个集群的操作。比如创建或删除索引，管理其它非master节点等。</li>
</ul>
</li>
<li>data节点<ul>
<li>配置文件中node.data属性为true(默认为true)，就有资格被设置成data节点。data节点主要用于执行数据相关的操作。比如文档的CRUD。</li>
</ul>
</li>
<li>客户端节点<ul>
<li>配置文件中node.master属性和node.data属性均为false。</li>
<li>该节点不能作为master节点，也不能作为data节点。</li>
<li>可以作为客户端节点，用于响应用户的请求，把请求转发到其他节点</li>
</ul>
</li>
<li>部落节点<ul>
<li>当一个节点配置tribe.*的时候，它是一个特殊的客户端，它可以连接多个集群，在所有连接的集群上执行<br>搜索和其他操作。</li>
</ul>
</li>
</ul>
<h3 id="搭建集群"><a href="#搭建集群" class="headerlink" title="搭建集群"></a>搭建集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动3个虚拟机，分别在3台虚拟机上部署安装Elasticsearch</span></span><br><span class="line">mkdir /itcast/es-cluster</span><br><span class="line"></span><br><span class="line"><span class="comment">#分发到其它机器</span></span><br><span class="line">scp -r es-cluster elsearch@192.168.40.134:/itcast</span><br><span class="line"></span><br><span class="line"><span class="comment">#node01的配置：</span></span><br><span class="line">cluster.name: es-itcast-cluster</span><br><span class="line">node.name: node01</span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"192.168.40.133"</span>,<span class="string">"192.168.40.134"</span>,<span class="string">"192.168.40.135"</span>]</span><br><span class="line"><span class="comment"># 最小节点数</span></span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line"><span class="comment"># 跨域专用</span></span><br><span class="line">http.cors.enabled: <span class="literal">true</span></span><br><span class="line">http.cors.allow-origin: <span class="string">"*"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#node02的配置：</span></span><br><span class="line">cluster.name: es-itcast-cluster</span><br><span class="line">node.name: node02</span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"192.168.40.133"</span>,<span class="string">"192.168.40.134"</span>,<span class="string">"192.168.40.135"</span>]</span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line">http.cors.enabled: <span class="literal">true</span></span><br><span class="line">http.cors.allow-origin: <span class="string">"*"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#node03的配置：</span></span><br><span class="line">cluster.name: es-itcast-cluster</span><br><span class="line">node.name: node02</span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"192.168.40.133"</span>,<span class="string">"192.168.40.134"</span>,<span class="string">"192.168.40.135"</span>]</span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line">http.cors.enabled: <span class="literal">true</span></span><br><span class="line">http.cors.allow-origin: <span class="string">"*"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#分别启动3个节点</span></span><br><span class="line">./elasticsearch</span><br></pre></td></tr></table></figure>

<p>查看集群</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126160551259.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>创建索引：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126160602652.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126160617217.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>查询集群状态：/_cluster/health<br>响应：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126181358687.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>集群中有三种颜色</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126181420256.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h3 id="分片和副本"><a href="#分片和副本" class="headerlink" title="分片和副本"></a>分片和副本</h3><p>为了将数据添加到Elasticsearch，我们需要索引(index)——一个存储关联数据的地方。实际上，索引只是一个用来指向一个或多个分片(shards)的“逻辑命名空间(logical namespace)”.</p>
<ul>
<li>一个分片(shard)是一个最小级别“工作单元(worker unit)”,它只是保存了索引中所有数据的一部分。</li>
<li>我们需要知道是分片就是一个Lucene实例，并且它本身就是一个完整的搜索引擎。应用程序不会和它直接通<br>信。</li>
<li>分片可以是主分片(primary shard)或者是复制分片(replica shard)。</li>
<li>索引中的每个文档属于一个单独的主分片，所以主分片的数量决定了索引最多能存储多少数据。</li>
<li>复制分片只是主分片的一个副本，它可以防止硬件故障导致的数据丢失，同时可以提供读请求，比如搜索或者从别的shard取回文档。</li>
<li>当索引创建完成的时候，主分片的数量就固定了，但是复制分片的数量可以随时调整。</li>
</ul>
<h3 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h3><h4 id="将data节点停止"><a href="#将data节点停止" class="headerlink" title="将data节点停止"></a>将data节点停止</h4><p>这里选择将node02停止：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126181440987.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>当前集群状态为黄色，表示主节点可用，副本节点不完全可用，过一段时间观察，发现节点列表中看不到node02，副本节点分配到了node01和node03，集群状态恢复到绿色。</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126181614881.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>将node02恢复： ./node02/1 bin/elasticsearch</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126181634283.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>可以看到，node02恢复后，重新加入了集群，并且重新分配了节点信息。</p>
<h4 id="将master节点停止"><a href="#将master节点停止" class="headerlink" title="将master节点停止"></a>将master节点停止</h4><p>接下来，测试将node01停止，也就是将主节点停止。</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/2020112618180951.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>从结果中可以看出，集群对master进行了重新选举，选择node03为master。并且集群状态变成黄色。<br>等待一段时间后，集群状态从黄色变为了绿色：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126181824556.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>恢复node01节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./node01/1 bin/elasticsearch</span><br></pre></td></tr></table></figure>

<p>重启之后，发现node01可以正常加入到集群中，集群状态依然为绿色：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126181841192.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>特别说明：</p>
<p>如果在配置文件中discovery.zen.minimum_master_nodes设置的不是N/2+1时，会出现脑裂问题，之前宕机<br>的主节点恢复后不会加入到集群。</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126181957227.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h3 id="分布式文档"><a href="#分布式文档" class="headerlink" title="分布式文档"></a>分布式文档</h3><h4 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h4><p>首先，来看个问题：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126182013239.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>如图所示：当我们想一个集群保存文档时，文档该存储到哪个节点呢？ 是随机吗？ 是轮询吗？实际上，在ELasticsearch中，会采用计算的方式来确定存储到哪个节点，计算公式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shard = <span class="built_in">hash</span>(routing) % number_1 of_primary_shards</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li>routing值是一个任意字符串，它默认是_id但也可以自定义。</li>
<li>这个routing字符串通过哈希函数生成一个数字，然后除以主切片的数量得到一个余数(remainder)，余数<br>的范围永远是0到number_of_primary_shards - 1，这个数字就是特定文档所在的分片</li>
</ul>
<p>这就是为什么创建了主分片后，不能修改的原因。</p>
<h4 id="文档的写操作"><a href="#文档的写操作" class="headerlink" title="文档的写操作"></a>文档的写操作</h4><p>新建、索引和删除请求都是写（write）操作，它们必须在主分片上成功完成才能复制分片上</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126200332801.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>下面我们罗列在主分片和复制分片上成功新建、索引或删除一个文档必要的顺序步骤：</p>
<ol>
<li>客户端给Node 1 发送新建、索引或删除请求。</li>
<li>节点使用文档的_id 确定文档属于分片0 。它转发请求到Node 3 ，分片0 位于这个节点上。</li>
<li>Node 3 在主分片上执行请求，如果成功，它转发请求到相应的位于Node 1 和Node 2 的复制节点上。当所有<br>的复制节点报告成功， Node 3 报告成功到请求的节点，请求的节点再报告给客户端。</li>
</ol>
<p>客户端接收到成功响应的时候，文档的修改已经被应用于主分片和所有的复制分片。你的修改生效了。</p>
<h3 id="搜索文档"><a href="#搜索文档" class="headerlink" title="搜索文档"></a>搜索文档</h3><p>文档能够从主分片或任意一个复制分片被检索。</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126200348224.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>下面我们罗列在主分片或复制分片上检索一个文档必要的顺序步骤：</p>
<ol>
<li>客户端给Node 1 发送get请求。</li>
<li>节点使用文档的_id 确定文档属于分片0 。分片0 对应的复制分片在三个节点上都有。此时，它转发请求到<br>Node 2 。</li>
<li>Node 2 返回文档(document)给Node 1 然后返回给客户端。对于读请求，为了平衡负载，请求节点会为每个请求选择不同的分片——它会循环所有分片副本。可能的情况是，一个被索引的文档已经存在于主分片上却还没来得及同步到复制分片上。这时复制分片会报告文档未找到，主分片会成功返回文档。一旦索引请求成功返回给用户，文档则在主分片和复制分片都是可用的。</li>
</ol>
<h3 id="全文搜索-2"><a href="#全文搜索-2" class="headerlink" title="全文搜索"></a>全文搜索</h3><p>对于全文搜索而言，文档可能分散在各个节点上，那么在分布式的情况下，如何搜索文档呢？</p>
<p>搜索，分为2个阶段，</p>
<ul>
<li>搜索（query）</li>
<li>取回（fetch）</li>
</ul>
<h4 id="搜索（query）"><a href="#搜索（query）" class="headerlink" title="搜索（query）"></a>搜索（query）</h4><p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126200404351.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>查询阶段包含以下三步：</p>
<ol>
<li>客户端发送一个search（搜索） 请求给Node 3 , Node 3 创建了一个长度为from+size 的空优先级队</li>
<li>Node 3 转发这个搜索请求到索引中每个分片的原本或副本。每个分片在本地执行这个查询并且结果将结果到<br>一个大小为from+size 的有序本地优先队列里去。</li>
<li>每个分片返回document的ID和它优先队列里的所有document的排序值给协调节点Node 3 。Node 3 把这些<br>值合并到自己的优先队列里产生全局排序结果。</li>
</ol>
<h4 id="取回-fetch"><a href="#取回-fetch" class="headerlink" title="取回 fetch"></a>取回 fetch</h4><p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126200416841.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>分发阶段由以下步骤构成：</p>
<ol>
<li>协调节点辨别出哪个document需要取回，并且向相关分片发出GET 请求。</li>
<li>每个分片加载document并且根据需要丰富（enrich）它们，然后再将document返回协调节点。</li>
<li>一旦所有的document都被取回，协调节点会将结果返回给客户端。</li>
</ol>
<h2 id="Java客户端"><a href="#Java客户端" class="headerlink" title="Java客户端"></a>Java客户端</h2><p>在Elasticsearch中，为java提供了2种客户端，一种是REST风格的客户端，另一种是Java API的客户端</p>
<h3 id="REST客户端"><a href="#REST客户端" class="headerlink" title="REST客户端"></a>REST客户端</h3><p>Elasticsearch提供了2种REST客户端，一种是低级客户端，一种是高级客户端。</p>
<ul>
<li>Java Low Level REST Client：官方提供的低级客户端。该客户端通过http来连接Elasticsearch集群。用户在使<br>用该客户端时需要将请求数据手动拼接成Elasticsearch所需JSON格式进行发送，收到响应时同样也需要将返回的JSON数据手动封装成对象。虽然麻烦，不过该客户端兼容所有的Elasticsearch版本。</li>
<li>Java High Level REST Client：官方提供的高级客户端。该客户端基于低级客户端实现，它提供了很多便捷的<br>API来解决低级客户端需要手动转换数据格式的问题。</li>
</ul>
<h3 id="构造数据-1"><a href="#构造数据-1" class="headerlink" title="构造数据"></a>构造数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /haoke/house/_bulk</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"index"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"haoke"</span>,<span class="string">"_type"</span>:<span class="string">"house"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"id"</span>:<span class="string">"1001"</span>,<span class="string">"title"</span>:<span class="string">"整租 · 南丹大楼 1居室 7500"</span>,<span class="string">"price"</span>:<span class="string">"7500"</span>&#125;</span><br><span class="line">&#123;<span class="string">"index"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"haoke"</span>,<span class="string">"_type"</span>:<span class="string">"house"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"id"</span>:<span class="string">"1002"</span>,<span class="string">"title"</span>:<span class="string">"陆家嘴板块，精装设计一室一厅，可拎包入住诚意租。"</span>,<span class="string">"price"</span>:<span class="string">"8500"</span>&#125;</span><br><span class="line">&#123;<span class="string">"index"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"haoke"</span>,<span class="string">"_type"</span>:<span class="string">"house"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"id"</span>:<span class="string">"1003"</span>,<span class="string">"title"</span>:<span class="string">"整租 · 健安坊 1居室 4050"</span>,<span class="string">"price"</span>:<span class="string">"7500"</span>&#125;</span><br><span class="line">&#123;<span class="string">"index"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"haoke"</span>,<span class="string">"_type"</span>:<span class="string">"house"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"id"</span>:<span class="string">"1004"</span>,<span class="string">"title"</span>:<span class="string">"整租 · 中凯城市之光+视野开阔+景色秀丽+拎包入住"</span>,<span class="string">"price"</span>:<span class="string">"6500"</span>&#125;</span><br><span class="line">&#123;<span class="string">"index"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"haoke"</span>,<span class="string">"_type"</span>:<span class="string">"house"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"id"</span>:<span class="string">"1005"</span>,<span class="string">"title"</span>:<span class="string">"整租 · 南京西路品质小区 21213三轨交汇 配套齐* 拎包入住"</span>,<span class="string">"price"</span>:<span class="string">"6000"</span>&#125;</span><br><span class="line">&#123;<span class="string">"index"</span>:&#123;<span class="string">"_index"</span>:<span class="string">"haoke"</span>,<span class="string">"_type"</span>:<span class="string">"house"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"id"</span>:<span class="string">"1006"</span>,<span class="string">"title"</span>:<span class="string">"祥康里 简约风格 *南户型 拎包入住 看房随时"</span>,<span class="string">"price"</span>:<span class="string">"7000"</span>&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201126212827815.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h3 id="REST低级客户端"><a href="#REST低级客户端" class="headerlink" title="REST低级客户端"></a>REST低级客户端</h3><p>创建项目，加入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Study_ElasticSearch_Code<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>7<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>7<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.8.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.11.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>编写测试类 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.util.EntityUtils;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.Request;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.Response;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClientBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用低级客户端 访问</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: 陌溪</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2020-09-23-16:33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ESApi</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> RestClient restClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectMapper MAPPER = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RestClientBuilder restClientBuilder = RestClient.builder(<span class="keyword">new</span> HttpHost(<span class="string">"202.193.56.222"</span>, <span class="number">9200</span>, <span class="string">"http"</span>));</span><br><span class="line">        <span class="keyword">this</span>.restClient = restClientBuilder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询集群状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetInfo</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Request request = <span class="keyword">new</span> Request(<span class="string">"GET"</span>, <span class="string">"/_cluster/state"</span>);</span><br><span class="line">        request.addParameter(<span class="string">"pretty"</span>, <span class="string">"true"</span>);</span><br><span class="line">        Response response = <span class="keyword">this</span>.restClient.performRequest(request);</span><br><span class="line">        System.out.println(response.getStatusLine());</span><br><span class="line">        System.out.println(EntityUtils.toString(response.getEntity()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据ID查询数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetHouseInfo</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Request request = <span class="keyword">new</span> Request(<span class="string">"GET"</span>, <span class="string">"/haoke/house/Z3CduXQBYpWein3CRFug"</span>);</span><br><span class="line">        request.addParameter(<span class="string">"pretty"</span>, <span class="string">"true"</span>);</span><br><span class="line">        Response response = <span class="keyword">this</span>.restClient.performRequest(request);</span><br><span class="line">        System.out.println(response.getStatusLine());</span><br><span class="line">        System.out.println(EntityUtils.toString(response.getEntity()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateData</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Request request = <span class="keyword">new</span> Request(<span class="string">"POST"</span>, <span class="string">"/haoke/house"</span>);</span><br><span class="line">        Map&lt;String, Object&gt; data = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        data.put(<span class="string">"id"</span>, <span class="string">"2001"</span>);</span><br><span class="line">        data.put(<span class="string">"title"</span>, <span class="string">"张江高科"</span>);</span><br><span class="line">        data.put(<span class="string">"price"</span>, <span class="string">"3500"</span>);</span><br><span class="line">        <span class="comment">// 写成JSON</span></span><br><span class="line">        request.setJsonEntity(MAPPER.writeValueAsString(data));</span><br><span class="line">        Response response = <span class="keyword">this</span>.restClient.performRequest(request);</span><br><span class="line">        System.out.println(response.getStatusLine());</span><br><span class="line">        System.out.println(EntityUtils.toString(response.getEntity()));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 搜索数据</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchData</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Request request = <span class="keyword">new</span> Request(<span class="string">"POST"</span>, <span class="string">"/haoke/house/_search"</span>);</span><br><span class="line">        String searchJson = <span class="string">"&#123;\"query\": &#123;\"match\": &#123;\"title\": \"拎包入住\"&#125;&#125;&#125;"</span>;</span><br><span class="line">        request.setJsonEntity(searchJson);</span><br><span class="line">        request.addParameter(<span class="string">"pretty"</span>,<span class="string">"true"</span>);</span><br><span class="line">        Response response = <span class="keyword">this</span>.restClient.performRequest(request);</span><br><span class="line">        System.out.println(response.getStatusLine());</span><br><span class="line">        System.out.println(EntityUtils.toString(response.getEntity()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ESApi esApi = <span class="keyword">new</span> ESApi();</span><br><span class="line">        esApi.init();</span><br><span class="line"><span class="comment">//        esApi.testGetInfo();</span></span><br><span class="line"><span class="comment">//        esApi.testGetHouseInfo();</span></span><br><span class="line">        esApi.testCreateData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="REST高级客户端"><a href="#REST高级客户端" class="headerlink" title="REST高级客户端"></a>REST高级客户端</h3><p>创建项目，引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.8.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>编写测试用例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.util.EntityUtils;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.ActionListener;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.delete.DeleteRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.delete.DeleteResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.get.GetRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.get.GetResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.update.UpdateRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.update.UpdateResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.*;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.Strings;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.unit.TimeValue;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.fetch.subphase.FetchSourceContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ES高级客户端</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: 陌溪</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2020-09-23-16:56</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ESHightApi</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RestClientBuilder restClientBuilder = RestClient.builder(</span><br><span class="line">                <span class="keyword">new</span> HttpHost(<span class="string">"202.193.56.222"</span>, <span class="number">9200</span>, <span class="string">"http"</span>));</span><br><span class="line">        <span class="keyword">this</span>.client = <span class="keyword">new</span> RestHighLevelClient(restClientBuilder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增文档，同步操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreate</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; data = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        data.put(<span class="string">"id"</span>, <span class="string">"2002"</span>);</span><br><span class="line">        data.put(<span class="string">"title"</span>, <span class="string">"南京西路 拎包入住 一室一厅"</span>);</span><br><span class="line">        data.put(<span class="string">"price"</span>, <span class="string">"4500"</span>);</span><br><span class="line">        IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(<span class="string">"haoke"</span>, <span class="string">"house"</span>)</span><br><span class="line">                .source(data);</span><br><span class="line">        IndexResponse indexResponse = <span class="keyword">this</span>.client.index(indexRequest,</span><br><span class="line">                RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(<span class="string">"id-&gt;"</span> + indexResponse.getId());</span><br><span class="line">        System.out.println(<span class="string">"index-&gt;"</span> + indexResponse.getIndex());</span><br><span class="line">        System.out.println(<span class="string">"type-&gt;"</span> + indexResponse.getType());</span><br><span class="line">        System.out.println(<span class="string">"version-&gt;"</span> + indexResponse.getVersion());</span><br><span class="line">        System.out.println(<span class="string">"result-&gt;"</span> + indexResponse.getResult());</span><br><span class="line">        System.out.println(<span class="string">"shardInfo-&gt;"</span> + indexResponse.getShardInfo());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异步创建文档</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateAsync</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; data = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        data.put(<span class="string">"id"</span>, <span class="string">"2003"</span>);</span><br><span class="line">        data.put(<span class="string">"title"</span>, <span class="string">"南京东路 最新房源 二室一厅"</span>);</span><br><span class="line">        data.put(<span class="string">"price"</span>, <span class="string">"5500"</span>);</span><br><span class="line">        IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(<span class="string">"haoke"</span>, <span class="string">"house"</span>)</span><br><span class="line">                .source(data);</span><br><span class="line">        <span class="keyword">this</span>.client.indexAsync(indexRequest, RequestOptions.DEFAULT, <span class="keyword">new</span></span><br><span class="line">                ActionListener&lt;IndexResponse&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(IndexResponse indexResponse)</span> </span>&#123;</span><br><span class="line">                        System.out.println(<span class="string">"id-&gt;"</span> + indexResponse.getId());</span><br><span class="line">                        System.out.println(<span class="string">"index-&gt;"</span> + indexResponse.getIndex());</span><br><span class="line">                        System.out.println(<span class="string">"type-&gt;"</span> + indexResponse.getType());</span><br><span class="line">                        System.out.println(<span class="string">"version-&gt;"</span> + indexResponse.getVersion());</span><br><span class="line">                        System.out.println(<span class="string">"result-&gt;"</span> + indexResponse.getResult());</span><br><span class="line">                        System.out.println(<span class="string">"shardInfo-&gt;"</span> + indexResponse.getShardInfo());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">                        System.out.println(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        System.out.println(<span class="string">"ok"</span>);</span><br><span class="line">        Thread.sleep(<span class="number">20000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQuery</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        GetRequest getRequest = <span class="keyword">new</span> GetRequest(<span class="string">"haoke"</span>, <span class="string">"house"</span>,</span><br><span class="line">                <span class="string">"GkpdE2gBCKv8opxuOj12"</span>);</span><br><span class="line">        <span class="comment">// 指定返回的字段</span></span><br><span class="line">        String[] includes = <span class="keyword">new</span> String[]&#123;<span class="string">"title"</span>, <span class="string">"id"</span>&#125;;</span><br><span class="line">        String[] excludes = Strings.EMPTY_ARRAY;</span><br><span class="line">        FetchSourceContext fetchSourceContext =</span><br><span class="line">                <span class="keyword">new</span> FetchSourceContext(<span class="keyword">true</span>, includes, excludes);</span><br><span class="line">        getRequest.fetchSourceContext(fetchSourceContext);</span><br><span class="line">        GetResponse response = <span class="keyword">this</span>.client.get(getRequest, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(<span class="string">"数据 -&gt; "</span> + response.getSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否存在</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testExists</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        GetRequest getRequest = <span class="keyword">new</span> GetRequest(<span class="string">"haoke"</span>, <span class="string">"house"</span>,</span><br><span class="line">                <span class="string">"GkpdE2gBCKv8opxuOj12"</span>);</span><br><span class="line"><span class="comment">// 不返回的字段</span></span><br><span class="line">        getRequest.fetchSourceContext(<span class="keyword">new</span> FetchSourceContext(<span class="keyword">false</span>));</span><br><span class="line">        <span class="keyword">boolean</span> exists = <span class="keyword">this</span>.client.exists(getRequest, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(<span class="string">"exists -&gt; "</span> + exists);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDelete</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        DeleteRequest deleteRequest = <span class="keyword">new</span> DeleteRequest(<span class="string">"haoke"</span>, <span class="string">"house"</span>,</span><br><span class="line">                <span class="string">"GkpdE2gBCKv8opxuOj12"</span>);</span><br><span class="line">        DeleteResponse response = <span class="keyword">this</span>.client.delete(deleteRequest,</span><br><span class="line">                RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(response.status());<span class="comment">// OK or NOT_FOUND</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdate</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        UpdateRequest updateRequest = <span class="keyword">new</span> UpdateRequest(<span class="string">"haoke"</span>, <span class="string">"house"</span>,</span><br><span class="line">                <span class="string">"G0pfE2gBCKv8opxuRz1y"</span>);</span><br><span class="line">        Map&lt;String, Object&gt; data = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        data.put(<span class="string">"title"</span>, <span class="string">"张江高科2"</span>);</span><br><span class="line">        data.put(<span class="string">"price"</span>, <span class="string">"5000"</span>);</span><br><span class="line">        updateRequest.doc(data);</span><br><span class="line">        UpdateResponse response = <span class="keyword">this</span>.client.update(updateRequest,</span><br><span class="line">                RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(<span class="string">"version -&gt; "</span> + response.getVersion());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试搜索</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearch</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"haoke"</span>);</span><br><span class="line">        searchRequest.types(<span class="string">"house"</span>);</span><br><span class="line">        SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        sourceBuilder.query(QueryBuilders.matchQuery(<span class="string">"title"</span>, <span class="string">"拎包入住"</span>));</span><br><span class="line">        sourceBuilder.from(<span class="number">0</span>);</span><br><span class="line">        sourceBuilder.size(<span class="number">5</span>);</span><br><span class="line">        sourceBuilder.timeout(<span class="keyword">new</span> TimeValue(<span class="number">60</span>, TimeUnit.SECONDS));</span><br><span class="line">        searchRequest.source(sourceBuilder);</span><br><span class="line">        SearchResponse search = <span class="keyword">this</span>.client.search(searchRequest,</span><br><span class="line">                RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(<span class="string">"搜索到 "</span> + search.getHits().totalHits + <span class="string">" 条数据."</span>);</span><br><span class="line">        SearchHits hits = search.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            System.out.println(hit.getSourceAsString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ESHightApi esHightApi = <span class="keyword">new</span> ESHightApi();</span><br><span class="line">        esHightApi.init();</span><br><span class="line">        esHightApi.testCreate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Beats入门简介"><a href="#Beats入门简介" class="headerlink" title="Beats入门简介"></a>Beats入门简介</h1><p>使用Beat收集nginx日志和指标数据</p>
<h2 id="项目需求"><a href="#项目需求" class="headerlink" title="项目需求"></a>项目需求</h2><p>Nginx是一款非常优秀的web服务器，往往nginx服务会作为项目的访问入口，那么，nginx的性能保障就变得非常重要了，如果nginx的运行出现了问题就会对项目有较大的影响，所以，我们需要对nginx的运行有监控措施，实时掌握nginx的运行情况，那就需要收集nginx的运行指标和分析nginx的运行日志了。</p>
<h2 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a>业务流程</h2><p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201127150952743.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>说明：</p>
<ul>
<li>通过Beats采集Nginx的指标数据和日志数据</li>
<li>Beats采集到数据后发送到Elasticsearch中</li>
<li>Kibana读取数据进行分析</li>
<li>用户通过Kibana进行查看分析报表</li>
</ul>
<h2 id="部署Nginx"><a href="#部署Nginx" class="headerlink" title="部署Nginx"></a>部署Nginx</h2><p>部署教程可以参考这篇博客：<a href="http://www.moguit.cn/#/info?blogUid=e8d3e38ba35b4765ae128256eb44e341" target="_blank" rel="noopener">CentOS下如何安装Nginx？</a></p>
<p>部署完成后，我们就可以启动nginx了</p>
<p>启动完成后，我们通过下面命令，就可以获取到nginx中的内容了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f /var/<span class="built_in">log</span>/nginx/access.log</span><br></pre></td></tr></table></figure>

<h2 id="Beats简介"><a href="#Beats简介" class="headerlink" title="Beats简介"></a>Beats简介</h2><p>通过查看ElasticStack可以发现，Beats主要用于采集数据</p>
<p>官网地址：<a href="https://www.elastic.co/cn/beats/" target="_blank" rel="noopener">https://www.elastic.co/cn/beats/</a></p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201127151404514.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>Beats平台其实是一个轻量性数据采集器，通过集合多种单一用途的采集器，从成百上千台机器中向Logstash或ElasticSearch中发送数据。</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/2020120309564925.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>通过Beats包含以下的数据采集功能</p>
<ul>
<li>Filebeat：采集日志文件</li>
<li>Metricbeat：采集指标</li>
<li>Packetbeat：采集网络数据</li>
</ul>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201203095730885.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>如果我们的数据不需要任何处理，那么就可以直接发送到ElasticSearch中</p>
<p>如果们的数据需要经过一些处理的话，那么就可以发送到Logstash中，然后处理完成后，在发送到ElasticSearch</p>
<p>最后在通过Kibana对我们的数据进行一系列的可视化展示</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201203095750319.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="Filebeat"><a href="#Filebeat" class="headerlink" title="Filebeat"></a>Filebeat</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>Filebeat是一个轻量级的日志采集器</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201203100002574.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="为什么要用Filebeat？"><a href="#为什么要用Filebeat？" class="headerlink" title="为什么要用Filebeat？"></a>为什么要用Filebeat？</h3><p>当你面对成百上千、甚至成千上万的服务器、虚拟机和溶气气生成的日志时，请告别SSH吧！Filebeat将为你提供一种轻量型方法，用于转发和汇总日志与文件，让简单的事情不再繁华，关于Filebeat的记住以下两点：</p>
<ul>
<li>轻量级日志采集器</li>
<li>输送至ElasticSearch或者Logstash，在Kibana中实现可视化</li>
</ul>
<h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p>用于监控、收集服务器日志文件.</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201203101812296.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>流程如下：</p>
<ul>
<li>首先是input输入，我们可以指定多个数据输入源，然后通过通配符进行日志文件的匹配</li>
<li>匹配到日志后，就会使用Harvester（收割机），将日志源源不断的读取到来</li>
<li>然后收割机收割到的日志，就传递到Spooler（卷轴），然后卷轴就在将他们传到对应的地方</li>
</ul>
<h3 id="下载-1"><a href="#下载-1" class="headerlink" title="下载"></a>下载</h3><p>官网地址：<a href="https://www.elastic.co/cn/downloads/beats/filebeat" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/beats/filebeat</a></p>
<p>选中对应版本的Filebeat，我这里是Centos部署的，所以下载Linux版本</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201203101841263.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>下载后，我们上传到服务器上，然后创建一个文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建文件夹</span></span><br><span class="line">mkdir -p /soft/beats</span><br><span class="line"><span class="comment"># 解压文件</span></span><br><span class="line">tar -zxvf filebeat-7.9.1-linux-x86_64.tar.gz </span><br><span class="line"><span class="comment"># 重命名</span></span><br><span class="line">mv filebeat-7.9.1-linux-x86_64/ filebeat</span><br></pre></td></tr></table></figure>

<p>然后我们进入到filebeat目录下，创建对应的配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入文件夹</span></span><br><span class="line"><span class="built_in">cd</span> filebeats</span><br><span class="line"><span class="comment"># 创建配置文件</span></span><br><span class="line">vim mogublog.yml</span><br></pre></td></tr></table></figure>

<p>添加如下内容</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span> <span class="comment"># filebeat input输入</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">stdin</span>    <span class="comment"># 标准输入</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span>  <span class="comment"># 启用标准输入</span></span><br><span class="line"><span class="attr">setup.template.settings:</span> </span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span> <span class="comment"># 指定下载数</span></span><br><span class="line"><span class="attr">output.console:</span>  <span class="comment"># 控制台输出</span></span><br><span class="line">  <span class="attr">pretty:</span> <span class="literal">true</span>   <span class="comment"># 启用美化功能</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>在我们添加完配置文件后，我们就可以对filebeat进行启动了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -e -c mogublog.yml</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/2020120311165099.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>然后我们在控制台输入hello，就能看到我们会有一个json的输出，是通过读取到我们控制台的内容后输出的</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201204095513548.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>内容如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"@timestamp"</span>:<span class="string">"2019-01-12T12:50:03.585Z"</span>,</span><br><span class="line">    "@metadata":&#123; #元数据信息</span><br><span class="line">        "beat":"filebeat",</span><br><span class="line">        "type":"doc",</span><br><span class="line">        "version":"6.5.4"</span><br><span class="line">    &#125;,</span><br><span class="line">    "source":"",</span><br><span class="line">    "offset":0,</span><br><span class="line">    "message":"hello", #元数据信息</span><br><span class="line">    "prospector":&#123;</span><br><span class="line">        "type":"stdin" #元数据信息</span><br><span class="line">    &#125;,</span><br><span class="line">    "input":&#123; #控制台标准输入</span><br><span class="line">        "type":"stdin"</span><br><span class="line">    &#125;,</span><br><span class="line">    "beat":&#123;  #beat版本以及主机信息</span><br><span class="line">        "name":"itcast01",</span><br><span class="line">        "hostname":"ElasticStack",</span><br><span class="line">        "version":"6.5.4"</span><br><span class="line">    &#125;,</span><br><span class="line">    "host":&#123;</span><br><span class="line">        "name":"ElasticStack"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="读取文件"><a href="#读取文件" class="headerlink" title="读取文件"></a>读取文件</h3><p>我们需要再次创建一个文件，叫 mogublog-log.yml，然后在文件里添加如下内容</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/soft/beats/logs/*.log</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">output.console:</span></span><br><span class="line">  <span class="attr">pretty:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>添加完成后，我们在到下面目录创建一个日志文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建文件夹</span></span><br><span class="line">mkdir -p /soft/beats/logs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入文件夹</span></span><br><span class="line"><span class="built_in">cd</span> /soft/beats/logs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 追加内容</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"hello"</span> &gt;&gt; a.log</span><br></pre></td></tr></table></figure>

<p>然后我们再次启动filebeat</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -e -c mogublog-log.yml</span><br></pre></td></tr></table></figure>

<p>能够发现，它已经成功加载到了我们的日志文件 a.log</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201203112711436.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>同时我们还可以继续往文件中追加内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"are you ok ?"</span> &gt;&gt; a.log</span><br></pre></td></tr></table></figure>

<p>追加后，我们再次查看filebeat，也能看到刚刚我们追加的内容</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201203112737398.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>可以看出，已经检测到日志文件有更新，立刻就会读取到更新的内容，并且输出到控制台。</p>
<h3 id="自定义字段"><a href="#自定义字段" class="headerlink" title="自定义字段"></a>自定义字段</h3><p>但我们的元数据没办法支撑我们的业务时，我们还可以自定义添加一些字段</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  paths:</span><br><span class="line">    - /soft/beats/logs/*.<span class="built_in">log</span></span><br><span class="line">  tags: [<span class="string">"web"</span>, <span class="string">"test"</span>]  <span class="comment">#添加自定义tag，便于后续的处理</span></span><br><span class="line">  fields:  <span class="comment">#添加自定义字段</span></span><br><span class="line">    from: <span class="built_in">test</span>-web</span><br><span class="line">  fields_under_root: <span class="literal">true</span> <span class="comment">#true为添加到根节点，false为添加到子节点中</span></span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">output.console:</span><br><span class="line">  pretty: <span class="literal">true</span></span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>添加完成后，我们重启 filebeat</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -e -c mogublog-log.yml</span><br></pre></td></tr></table></figure>

<p>然后添加新的数据到 a.log中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"test-web"</span> &gt;&gt; a.log</span><br></pre></td></tr></table></figure>

<p>我们就可以看到字段在原来的基础上，增加了两个</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201204100432391.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="输出到ElasticSearch"><a href="#输出到ElasticSearch" class="headerlink" title="输出到ElasticSearch"></a>输出到ElasticSearch</h3><p>我们可以通过配置，将修改成如下所示</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/soft/beats/logs/*.log</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">["web",</span> <span class="string">"test"</span><span class="string">]</span></span><br><span class="line">  <span class="attr">fields:</span></span><br><span class="line">    <span class="attr">from:</span> <span class="string">test-web</span></span><br><span class="line">  <span class="attr">fields_under_root:</span> <span class="literal">false</span> </span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">["127.0.0.1:9200"]</span></span><br></pre></td></tr></table></figure>

<p>启动成功后，我们就能看到它已经成功连接到了es了</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201203193340334.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>然后我们到刚刚的 logs文件夹向 a.log文件中添加内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"hello mogublog"</span> &gt;&gt; a.log</span><br></pre></td></tr></table></figure>

<p>在ES中，我们可以看到，多出了一个 filebeat的索引库</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201204113053742.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>然后我们浏览对应的数据，看看是否有插入的数据内容<br><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/2020120416522117.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="Filebeat工作原理"><a href="#Filebeat工作原理" class="headerlink" title="Filebeat工作原理"></a>Filebeat工作原理</h3><p>Filebeat主要由下面几个组件组成： harvester、prospector 、input</p>
<h4 id="harvester"><a href="#harvester" class="headerlink" title="harvester"></a>harvester</h4><ul>
<li>负责读取单个文件的内容</li>
<li>harvester逐行读取每个文件（一行一行读取），并把这些内容发送到输出</li>
<li>每个文件启动一个harvester，并且harvester负责打开和关闭这些文件，这就意味着harvester运行时文件描述符保持着打开的状态。</li>
<li>在harvester正在读取文件内容的时候，文件被删除或者重命名了，那么Filebeat就会续读这个文件，这就会造成一个问题，就是只要负责这个文件的harvester没用关闭，那么磁盘空间就不会被释放，默认情况下，Filebeat保存问价你打开直到close_inactive到达</li>
</ul>
<h4 id="prospector"><a href="#prospector" class="headerlink" title="prospector"></a>prospector</h4><ul>
<li><p>prospector负责管理harvester并找到所有要读取的文件来源</p>
</li>
<li><p>如果输入类型为日志，则查找器将查找路径匹配的所有文件，并为每个文件启动一个harvester</p>
</li>
<li><p>Filebeat目前支持两种prospector类型：log和stdin</p>
</li>
<li><p>Filebeat如何保持文件的状态</p>
<ul>
<li>Filebeat保存每个文件的状态并经常将状态刷新到磁盘上的注册文件中</li>
<li>该状态用于记住harvester正在读取的最后偏移量，并确保发送所有日志行。</li>
<li>如果输出（例如ElasticSearch或Logstash）无法访问，Filebeat会跟踪最后发送的行，并在输出再次可以用时继续读取文件。</li>
<li>在Filebeat运行时，每个prospector内存中也会保存的文件状态信息，当重新启动Filebat时，将使用注册文件的数量来重建文件状态，Filebeat将每个harvester在从保存的最后偏移量继续读取</li>
<li>文件状态记录在data/registry文件中</li>
</ul>
</li>
</ul>
<h3 id="input"><a href="#input" class="headerlink" title="input"></a>input</h3><ul>
<li><p>一个input负责管理harvester，并找到所有要读取的源</p>
</li>
<li><p>如果input类型是log，则input查找驱动器上与已定义的glob路径匹配的所有文件，并为每个文件启动一个harvester</p>
</li>
<li><p>每个input都在自己的Go例程中运行</p>
</li>
<li><p>下面的例子配置Filebeat从所有匹配指定的glob模式的文件中读取行</p>
</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/*.log</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/path2/*.log</span></span><br></pre></td></tr></table></figure>

<h3 id="启动命令"><a href="#启动命令" class="headerlink" title="启动命令"></a>启动命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -e -c mogublog-es.yml</span><br><span class="line">./filebeat -e -c mogublog-es.yml -d <span class="string">"publish"</span></span><br></pre></td></tr></table></figure>

<h3 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h3><ul>
<li><strong>-e：</strong>输出到标准输出，默认输出到syslog和logs下</li>
<li><strong>-c：</strong>指定配置文件</li>
<li><strong>-d：</strong>输出debug信息</li>
</ul>
<h3 id="读取Nginx中的配置文件"><a href="#读取Nginx中的配置文件" class="headerlink" title="读取Nginx中的配置文件"></a>读取Nginx中的配置文件</h3><p>我们需要创建一个 mogublog-nginx.yml配置文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/soft/nginx/*.log</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">["nginx"]</span></span><br><span class="line">  <span class="attr">fields_under_root:</span> <span class="literal">false</span> </span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">["127.0.0.1:9200"]</span></span><br></pre></td></tr></table></figure>

<p>启动后，可以在Elasticsearch中看到索引以及查看数据<br><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201204170846465.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>可以看到，在message中已经获取到了nginx的日志，但是，内容并没有经过处理，只是读取到原数据，那么对于我们后期的操作是不利的，有办法解决吗？<br><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201204170834163.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="Module"><a href="#Module" class="headerlink" title="Module"></a>Module</h3><p>前面要想实现日志数据的读取以及处理都是自己手动配置的，其实，在Filebeat中，有大量的Module，可以简化我们的配置，直接就可以使用，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat modules list</span><br></pre></td></tr></table></figure>

<p>得到的列表如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">Disabled:</span><br><span class="line">activemq</span><br><span class="line">apache</span><br><span class="line">auditd</span><br><span class="line">aws</span><br><span class="line">azure</span><br><span class="line">barracuda</span><br><span class="line">bluecoat</span><br><span class="line">cef</span><br><span class="line">checkpoint</span><br><span class="line">cisco</span><br><span class="line">coredns</span><br><span class="line">crowdstrike</span><br><span class="line">cylance</span><br><span class="line">elasticsearch</span><br><span class="line">envoyproxy</span><br><span class="line">f5</span><br><span class="line">fortinet</span><br><span class="line">googlecloud</span><br><span class="line">gsuite</span><br><span class="line">haproxy</span><br><span class="line">ibmmq</span><br><span class="line">icinga</span><br><span class="line">iis</span><br><span class="line">imperva</span><br><span class="line">infoblox</span><br><span class="line">iptables</span><br><span class="line">juniper</span><br><span class="line">kafka</span><br><span class="line">kibana</span><br><span class="line">logstash</span><br><span class="line">microsoft</span><br><span class="line">misp</span><br><span class="line">mongodb</span><br><span class="line">mssql</span><br><span class="line">mysql</span><br><span class="line">nats</span><br><span class="line">netflow</span><br><span class="line">netscout</span><br><span class="line">nginx</span><br><span class="line">o365</span><br><span class="line">okta</span><br><span class="line">osquery</span><br><span class="line">panw</span><br><span class="line">postgresql</span><br><span class="line">rabbitmq</span><br><span class="line">radware</span><br><span class="line">redis</span><br><span class="line">santa</span><br><span class="line">sonicwall</span><br><span class="line">sophos</span><br><span class="line">squid</span><br><span class="line">suricata</span><br><span class="line">system</span><br><span class="line">tomcat</span><br><span class="line">traefik</span><br><span class="line">zeek</span><br><span class="line">zscaler</span><br></pre></td></tr></table></figure>

<p>可以看到，内置了很多的module，但是都没有启用，如果需要启用需要进行enable操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动</span></span><br><span class="line">./filebeat modules <span class="built_in">enable</span> nginx </span><br><span class="line"><span class="comment">#禁用</span></span><br><span class="line">./filebeat modules <span class="built_in">disable</span> nginx</span><br></pre></td></tr></table></figure>

<p>可以发现，nginx的module已经被启用。</p>
<h4 id="nginx-module-配置"><a href="#nginx-module-配置" class="headerlink" title="nginx module 配置"></a>nginx module 配置</h4><p>我们到下面的目录，就能看到module的配置了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入到module目录</span></span><br><span class="line"><span class="built_in">cd</span> modules.d/</span><br><span class="line"><span class="comment">#查看文件</span></span><br><span class="line">vim nginx.yml.disabled</span><br></pre></td></tr></table></figure>

<p>得到的文件内容如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Module: nginx</span></span><br><span class="line"><span class="comment"># Docs: https://www.elastic.co/guide/en/beats/filebeat/7.9/filebeat-module-nginx.html</span></span><br><span class="line"></span><br><span class="line">- module: nginx</span><br><span class="line">  <span class="comment"># Access logs</span></span><br><span class="line">  access:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 添加日志文件</span></span><br><span class="line">    var.paths: [<span class="string">"/var/log/nginx/access.log*"</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Set custom paths for the log files. If left empty,</span></span><br><span class="line">    <span class="comment"># Filebeat will choose the paths depending on your OS.</span></span><br><span class="line">    <span class="comment">#var.paths:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Error logs</span></span><br><span class="line">  error:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    var.paths: [<span class="string">"/var/log/nginx/error.log*"</span>]</span><br></pre></td></tr></table></figure>

<h4 id="配置filebeat"><a href="#配置filebeat" class="headerlink" title="配置filebeat"></a>配置filebeat</h4><p>我们需要修改刚刚的mogublog-nginx.yml文件，然后添加到我们的module</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">["127.0.0.1:9200"]</span></span><br><span class="line"><span class="attr">filebeat.config.modules:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">$&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class="line">  <span class="attr">reload.enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p>我们启动我们的filebeat</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -e -c itcast-nginx.yml</span><br></pre></td></tr></table></figure>

<p>如果启动的时候发现出错了，错误如下所示，执行如图所示的脚本即可 【新版本的ES好像不会出现这个错误】</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动会出错，如下</span></span><br><span class="line">ERROR fileset/factory.go:142 Error loading pipeline: Error loading pipeline <span class="keyword">for</span></span><br><span class="line">fileset nginx/access: This module requires the following Elasticsearch plugins:</span><br><span class="line">ingest-user-agent, ingest-geoip. You can install them by running the following</span><br><span class="line">commands on all the Elasticsearch nodes:</span><br><span class="line">  sudo bin/elasticsearch-plugin install ingest-user-agent</span><br><span class="line">  sudo bin/elasticsearch-plugin install ingest-geoip</span><br></pre></td></tr></table></figure>

<p>启动成功后，能看到日志记录已经成功刷新进去了</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/2020120417274050.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>我们可以测试一下，刷新nginx页面，或者向错误日志中，插入数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"err"</span> &gt;&gt; error.log</span><br></pre></td></tr></table></figure>

<p>能够看到，刚刚的记录已经成功插入了</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201204172959792.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>关于module的其它使用，可以参考文档：</p>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-modules.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-modules.html</a></p>
<h2 id="Metricbeat"><a href="#Metricbeat" class="headerlink" title="Metricbeat"></a>Metricbeat</h2><p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/2020120419302563.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<ul>
<li>定期收集操作系统或应用服务的指标数据</li>
<li>存储到Elasticsearch中，进行实时分析</li>
</ul>
<h3 id="Metricbeat组成"><a href="#Metricbeat组成" class="headerlink" title="Metricbeat组成"></a>Metricbeat组成</h3><p>Metricbeat有2部分组成，一部分是Module，另一个部分为Metricset</p>
<ul>
<li>Module<ul>
<li>收集的对象：如 MySQL、Redis、Nginx、操作系统等</li>
</ul>
</li>
<li>Metricset<ul>
<li>收集指标的集合：如 cpu、memory，network等</li>
</ul>
</li>
</ul>
<p>以Redis Module为例：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201204193100690.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="下载-2"><a href="#下载-2" class="headerlink" title="下载"></a>下载</h3><p>首先我们到<a href="https://www.elastic.co/cn/downloads/beats/metricbeat" target="_blank" rel="noopener">官网</a>，找到Metricbeat进行下载</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201204195118128.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>下载完成后，我们通过xftp工具，移动到指定的目录下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 移动到该目录下</span></span><br><span class="line"><span class="built_in">cd</span> /soft/beats</span><br><span class="line"><span class="comment"># 解压文件</span></span><br><span class="line">tar -zxvf </span><br><span class="line"><span class="comment"># 修改文件名</span></span><br><span class="line">mv  metricbeat</span><br></pre></td></tr></table></figure>

<p>然后修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim metricbeat.yml</span><br></pre></td></tr></table></figure>

<p>添加如下内容</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metricbeat.config.modules:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">$&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class="line">  <span class="attr">reload.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">index.codec:</span> <span class="string">best_compression</span></span><br><span class="line"><span class="attr">setup.kibana:</span></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">[""127.0.0.1:9200"]</span></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_host_metadata:</span> <span class="string">~</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_cloud_metadata:</span> <span class="string">~</span></span><br></pre></td></tr></table></figure>

<p>默认会指定的配置文件，就是在</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$&#123;path.config&#125;</span>/modules.d/*.yml</span><br></pre></td></tr></table></figure>

<p>也就是 system.yml文件，我们也可以自行开启其它的收集</p>
<h3 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h3><p>在配置完成后，我们通过如下命令启动即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./metricbeat -e</span><br></pre></td></tr></table></figure>

<p>在ELasticsearch中可以看到，系统的一些指标数据已经写入进去了：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201204202027185.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="system-module配置"><a href="#system-module配置" class="headerlink" title="system module配置"></a>system module配置</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">module:</span> <span class="string">system</span></span><br><span class="line">  <span class="attr">period:</span> <span class="string">10s</span>  <span class="comment"># 采集的频率，每10秒采集一次</span></span><br><span class="line">  <span class="attr">metricsets:</span>  <span class="comment"># 采集的内容</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cpu</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">load</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">memory</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">network</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">process</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">process_summary</span></span><br></pre></td></tr></table></figure>

<h3 id="Metricbeat-Module"><a href="#Metricbeat-Module" class="headerlink" title="Metricbeat Module"></a>Metricbeat Module</h3><p>Metricbeat Module的用法和我们之前学的filebeat的用法差不多</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看列表</span></span><br><span class="line">./metricbeat modules list</span><br></pre></td></tr></table></figure>

<p>能够看到对应的列表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Enabled:</span><br><span class="line">system <span class="comment">#默认启用</span></span><br><span class="line"></span><br><span class="line">Disabled:</span><br><span class="line">aerospike</span><br><span class="line">apache</span><br><span class="line">ceph</span><br><span class="line">couchbase</span><br><span class="line">docker</span><br><span class="line">dropwizard</span><br><span class="line">elasticsearch</span><br><span class="line">envoyproxy</span><br><span class="line">etcd</span><br><span class="line">golang</span><br><span class="line">graphite</span><br><span class="line">haproxy</span><br><span class="line">http</span><br><span class="line">jolokia</span><br><span class="line">kafka</span><br><span class="line">kibana</span><br><span class="line">kubernetes</span><br><span class="line">kvm</span><br><span class="line">logstash</span><br><span class="line">memcached</span><br><span class="line">mongodb</span><br><span class="line">munin</span><br><span class="line">mysql</span><br><span class="line">nginx</span><br><span class="line">php_fpm</span><br><span class="line">postgresql</span><br><span class="line">prometheus</span><br><span class="line">rabbitmq</span><br><span class="line">redis</span><br><span class="line">traefik</span><br><span class="line">uwsgi</span><br><span class="line">vsphere</span><br><span class="line">windows</span><br></pre></td></tr></table></figure>

<h3 id="Nginx-Module"><a href="#Nginx-Module" class="headerlink" title="Nginx Module"></a>Nginx Module</h3><h4 id="开启Nginx-Module"><a href="#开启Nginx-Module" class="headerlink" title="开启Nginx Module"></a>开启Nginx Module</h4><p>在nginx中，需要开启状态查询，才能查询到指标数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#重新编译nginx</span></span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/nginx --with-http_stub_status_module</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">./nginx -V <span class="comment">#查询版本信息</span></span><br><span class="line">nginx version: nginx/1.11.6</span><br><span class="line">built by gcc 4.4.7 20120313 (Red Hat 4.4.7-23) (GCC)</span><br><span class="line">configure arguments: --prefix=/usr/<span class="built_in">local</span>/nginx --with-http_stub_status_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置nginx</span></span><br><span class="line">vim nginx.conf</span><br><span class="line">location /nginx-status &#123;</span><br><span class="line">    stub_status on;</span><br><span class="line">    access_log off;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启nginx</span></span><br><span class="line">./nginx -s reload</span><br></pre></td></tr></table></figure>

<p>测试</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201204213333452.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>结果说明：</p>
<ul>
<li>Active connections：正在处理的活动连接数</li>
<li>server accepts handled requests<ul>
<li>第一个 server 表示Nginx启动到现在共处理了9个连接</li>
<li>第二个 accepts 表示Nginx启动到现在共成功创建 9 次握手</li>
<li>第三个 handled requests 表示总共处理了 21 次请求</li>
<li>请求丢失数 = 握手数 - 连接数 ，可以看出目前为止没有丢失请求</li>
</ul>
</li>
<li>Reading: 0 Writing: 1 Waiting: 1<ul>
<li>Reading：Nginx 读取到客户端的 Header 信息数</li>
<li>Writing：Nginx 返回给客户端 Header 信息数</li>
<li>Waiting：Nginx 已经处理完正在等候下一次请求指令的驻留链接（开启keep-alive的情况下，这个值等于<br>Active - (Reading+Writing)）</li>
</ul>
</li>
</ul>
<h3 id="配置nginx-module"><a href="#配置nginx-module" class="headerlink" title="配置nginx module"></a>配置nginx module</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启用redis module</span></span><br><span class="line">./metricbeat modules <span class="built_in">enable</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改redis module配置</span></span><br><span class="line">vim modules.d/nginx.yml</span><br></pre></td></tr></table></figure>

<p>然后修改下面的信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Module: nginx</span></span><br><span class="line"><span class="comment"># Docs: https://www.elastic.co/guide/en/beats/metricbeat/6.5/metricbeat-modulenginx.</span></span><br><span class="line">html</span><br><span class="line">  - module: nginx</span><br><span class="line"><span class="comment">#metricsets:</span></span><br><span class="line"><span class="comment"># - stubstatus</span></span><br><span class="line">  period: 10s</span><br><span class="line"><span class="comment"># Nginx hosts</span></span><br><span class="line">  hosts: [<span class="string">"http://127.0.0.1"</span>]</span><br><span class="line"><span class="comment"># Path to server status. Default server-status</span></span><br><span class="line">  server_status_path: <span class="string">"nginx-status"</span></span><br><span class="line"><span class="comment">#username: "user"</span></span><br><span class="line"><span class="comment">#password: "secret"</span></span><br></pre></td></tr></table></figure>

<p>修改完成后，启动nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动</span></span><br><span class="line">./metricbeat -e</span><br></pre></td></tr></table></figure>

<h3 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h3><p>我们能看到，我们的nginx数据已经成功的采集到我们的系统中了</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201204214540992.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>可以看到，nginx的指标数据已经写入到了Elasticsearch。</p>
<p>更多的Module使用参见官方文档：</p>
<p><a href="https://www.elastic.co/guide/en/beats/metricbeat/current/metricbeat-modules.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/metricbeat/current/metricbeat-modules.html</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://www.cnblogs.com/cjsblog/p/9495024.html" target="_blank" rel="noopener">Filebeat 模块与配置</a></p>
<p><a href="https://www.bilibili.com/video/BV1iJ411c7Az" target="_blank" rel="noopener">Elastic Stack（ELK）从入门到实践</a></p>
<h1 id="Kibana入门"><a href="#Kibana入门" class="headerlink" title="Kibana入门"></a>Kibana入门</h1><p>Kibana 是一款开源的数据分析和可视化平台，它是 Elastic Stack 成员之一，设计用于和 Elasticsearch 协作。您可以使用 Kibana 对 Elasticsearch 索引中的数据进行搜索、查看、交互操作。您可以很方便的利用图表、表格及地图对数据进行多元化的分析和呈现。</p>
<p>官网：<a href="https://www.elastic.co/cn/kibana" target="_blank" rel="noopener">https://www.elastic.co/cn/kibana</a><br><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207162831496.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="配置和安装"><a href="#配置和安装" class="headerlink" title="配置和安装"></a>配置和安装</h2><p>到下载地址，选择对应的版本：<a href="https://www.elastic.co/cn/downloads/kibana" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/kibana</a></p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207162846901.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>下载完成后，将文件拷贝到我们的服务器上，然后解压</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压</span></span><br><span class="line">tar -zxvf kibana-7.9.1-linux-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名</span></span><br><span class="line">mv kibana-7.9.1-linux-x86_64 kibana</span><br></pre></td></tr></table></figure>

<p>然后在进入kibana目录，找到config文件夹下的kibana.yml进行配置的修改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /soft/kibana/config/kibana.yml</span><br></pre></td></tr></table></figure>

<p>然后找到下面的内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#对外暴露服务的地址</span></span><br><span class="line">server.host: <span class="string">"0.0.0.0"</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#配置Elasticsearch</span></span><br><span class="line">elasticsearch.url: <span class="string">"http://127.0.0.1:9200"</span></span><br></pre></td></tr></table></figure>

<h2 id="启动-2"><a href="#启动-2" class="headerlink" title="启动"></a>启动</h2><p>修改配置完成后，我们就可以启动kibana了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动</span></span><br><span class="line">./bin/kibana</span><br></pre></td></tr></table></figure>

<p>点击启动，发现报错了</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207185638186.png" alt="在这里插入图片描述"></p>
<p>原因是kibana不能使用root用户进行启动，所以我们切换到elsearch用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将soft文件夹的所属者改成elsearch</span></span><br><span class="line">chown elsearch:elsearch /soft/ -R</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换用户</span></span><br><span class="line">su elsearch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">./bin/kibana</span><br></pre></td></tr></table></figure>

<p>然后打开下面的地址，即可访问我们的kibana了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://202.193.56.222:5601/</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207185716473.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207185758482.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="功能说明"><a href="#功能说明" class="headerlink" title="功能说明"></a>功能说明</h2><p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207185855743.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<ul>
<li>Discover：数据探索</li>
<li>Visualize：可视化</li>
<li>Dashboard：仪表盘</li>
<li>Timelion：时序控件</li>
<li>Canvas：画布</li>
<li>Machine Learning：机器学习</li>
<li>Infrastructure：基本信息</li>
<li>Logs：数据日志展示</li>
<li>APM：性能监控</li>
<li>Dev Tools：开发者工具</li>
<li>Monitoring：监控</li>
<li>Management：管理</li>
</ul>
<h2 id="数据探索"><a href="#数据探索" class="headerlink" title="数据探索"></a>数据探索</h2><p>先添加索引信息</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207185942395.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>然后我们就输入匹配规则进行匹配</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207190023765.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>然后选择时间字段，一般选择第一个</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207190056221.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>索引创建完毕后</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207190136734.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>然后我们就可以往nginx error.log日志文件中，添加几天错误记录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"hello error"</span> &gt;&gt; error.log</span><br></pre></td></tr></table></figure>

<p>我们追加了两条数据，然后到kibana的discover中，刷新页面，就能够看到我们刚添加的日志了，同时我们点击右侧还可以选择需要展示的字段，非常的方便</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207195242913.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>点击右上角，我们还可以针对时间来进行过滤</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207195257290.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="Metricbeat仪表盘"><a href="#Metricbeat仪表盘" class="headerlink" title="Metricbeat仪表盘"></a>Metricbeat仪表盘</h2><p>现在将Metricbeat的数据展示在Kibana中，首先需要修改我们的MetricBeat配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改metricbeat配置</span></span><br><span class="line">setup.kibana:</span><br><span class="line">  host: <span class="string">"192.168.40.133:5601"</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">#安装仪表盘到Kibana【需要确保Kibana在正常运行，这个过程可能会有些耗时】</span></span><br><span class="line">./metricbeat setup --dashboards</span><br></pre></td></tr></table></figure>

<p>安装完成后，如下所示</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207201458155.png" alt="在这里插入图片描述"></p>
<p>然后我们启动Metricbeat</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;metricbeat -e</span><br></pre></td></tr></table></figure>

<p>然后到kibana页面下，找到我们刚刚安装的仪表盘</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207201751253.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>然后我们就能够看到非常多的指标数据了</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207201815361.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="Nginx指标仪表盘【Metricbeat】"><a href="#Nginx指标仪表盘【Metricbeat】" class="headerlink" title="Nginx指标仪表盘【Metricbeat】"></a>Nginx指标仪表盘【Metricbeat】</h2><p>选择Metricbeat的nginx仪表盘即可</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207203300116.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>然后就能够看到Nginx的指标信息了</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207203248593.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201207203807952.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="Nginx日志仪表盘"><a href="#Nginx日志仪表盘" class="headerlink" title="Nginx日志仪表盘"></a>Nginx日志仪表盘</h2><p>我们可以和刚刚Metricbeat的仪表盘一样，也可以将filebeat收集的日志记录，推送到Kibana中</p>
<p>首先我们需要修改filebeat的 mogublog-nginx.yml配置文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">["127.0.0.1:9200"]</span></span><br><span class="line"><span class="attr">filebeat.config.modules:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">$&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class="line">  <span class="attr">reload.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.kibana:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">"127.0.0.1:5601"</span></span><br></pre></td></tr></table></figure>

<p>然后按照仪表盘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -c mogublog-nginx.yml setup</span><br></pre></td></tr></table></figure>

<p>等待一会后，仪表盘也安装成功了</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208091459342.png" alt="在这里插入图片描述"></p>
<p>然后我们启动filebeat即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -e -c mogublog-nginx.yml</span><br></pre></td></tr></table></figure>

<p>启动完成后，我们回到我们的Kibana中，找到Dashboard，添加我们的filebeat - nginx即可</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208091804303.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>然后就能看到我们的仪表盘了，上图就是请求的来源</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208091831558.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<blockquote>
<p>需要注意的是，这些仪表盘本身是没有的，我们需要通过filebeat来进行安装</p>
</blockquote>
<h2 id="Kibana自定义仪表盘"><a href="#Kibana自定义仪表盘" class="headerlink" title="Kibana自定义仪表盘"></a>Kibana自定义仪表盘</h2><p>在Kibana中，我们也可以自定义图标，如制作柱形图</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208095759618.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>我们选择最下面的 Vertical Bar，也就是柱形图，然后在选择我们的索引</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208095606788.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>这样就出来了</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208102649844.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="开发者工具"><a href="#开发者工具" class="headerlink" title="开发者工具"></a>开发者工具</h2><p>在Kibana中，为开发者的测试提供了便捷的工具使用，如下：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208095651127.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>我们就可以在这里面写一些请求了</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208095708836.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h1 id="Logstash入门简介"><a href="#Logstash入门简介" class="headerlink" title="Logstash入门简介"></a>Logstash入门简介</h1><h2 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h2><p>Logstash是一个开源的服务器端数据处理管道，能够同时从多个来源采集数据，转换数据，然后将数据发送到最喜欢的存储库中（我们的存储库当然是ElasticSearch）</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208103929508.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>我们回到我们ElasticStack的架构图，可以看到Logstash是充当数据处理的需求的，当我们的数据需要处理的时候，会将它发送到Logstash进行处理，否则直接送到ElasticSearch中</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208103944997.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h2><p>Logstash可以处理各种各样的输入，从文档，图表中=，数据库中，然后处理完后，发送到</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208104019380.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="部署安装"><a href="#部署安装" class="headerlink" title="部署安装"></a>部署安装</h2><p>Logstash主要是将数据源的数据进行一行一行的处理，同时还直接过滤切割等功能。</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208104009313.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>首先到官网下载logstash：<a href="https://www.elastic.co/cn/downloads/logstash" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/logstash</a></p>
<p>选择我们需要下载的版本：</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208104156288.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>下载完成后，使用xftp工具，将其丢入到服务器中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#检查jdk环境，要求jdk1.8+</span></span><br><span class="line">java -version</span><br><span class="line"></span><br><span class="line"><span class="comment">#解压安装包</span></span><br><span class="line">tar -xvf logstash-7.9.1.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#第一个logstash示例</span></span><br><span class="line">bin/logstash -e <span class="string">'input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;'</span></span><br></pre></td></tr></table></figure>

<p>其实原来的logstash的作用，就是为了做数据的采集，但是因为logstash的速度比较慢，所以后面使用beats来代替了Logstash，当我们使用上面的命令进行启动的时候，就可以发现了，因为logstash使用java写的，首先需要启动虚拟机，最后下图就是启动完成的截图<br><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208111523275.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h2><p>我们在控制台输入 hello，马上就能看到它的输出信息</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208111544286.png" alt="在这里插入图片描述"></p>
<h2 id="配置详解"><a href="#配置详解" class="headerlink" title="配置详解"></a>配置详解</h2><p>Logstash的配置有三部分，如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">input &#123; <span class="comment">#输入</span></span><br><span class="line">stdin &#123; ... &#125; <span class="comment">#标准输入</span></span><br><span class="line">&#125;</span><br><span class="line">filter &#123; <span class="comment">#过滤，对数据进行分割、截取等处理</span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">output &#123; <span class="comment">#输出</span></span><br><span class="line">stdout &#123; ... &#125; <span class="comment">#标准输出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="输入"><a href="#输入" class="headerlink" title="输入"></a>输入</h3><ul>
<li>采集各种样式、大小和来源的数据，数据往往以各种各样的形式，或分散或集中地存在于很多系统中。</li>
<li>Logstash 支持各种输入选择 ，可以在同一时间从众多常用来源捕捉事件。能够以连续的流式传输方式，轻松地从您的日志、指标、Web 应用、数据存储以及各种 AWS 服务采集数据。</li>
</ul>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208161841355.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h3><ul>
<li>实时解析和转换数据</li>
<li>数据从源传输到存储库的过程中，Logstash 过滤器能够解析各个事件，识别已命名的字段以构建结构，并将它们转换成通用格式，以便更轻松、更快速地分析和实现商业价值。</li>
</ul>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208162032476.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h3><p>Logstash 提供众多输出选择，您可以将数据发送到您要指定的地方，并且能够灵活地解锁众多下游用例。<br><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208162130969.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="读取自定义日志"><a href="#读取自定义日志" class="headerlink" title="读取自定义日志"></a>读取自定义日志</h2><p>前面我们通过Filebeat读取了nginx的日志，如果是自定义结构的日志，就需要读取处理后才能使用，所以，这个时候就需要使用Logstash了，因为Logstash有着强大的处理能力，可以应对各种各样的场景。</p>
<h3 id="日志结构"><a href="#日志结构" class="headerlink" title="日志结构"></a>日志结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2019-03-15 21:21:21|ERROR|1 读取数据出错|参数：id=1002</span><br></pre></td></tr></table></figure>

<p>可以看到，日志中的内容是使用“|”进行分割的，使用，我们在处理的时候，也需要对数据做分割处理。</p>
<h3 id="编写配置文件"><a href="#编写配置文件" class="headerlink" title="编写配置文件"></a>编写配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim mogublog-pipeline.conf</span><br></pre></td></tr></table></figure>

<p>然后添加如下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; <span class="string">"/soft/beats/logs/app.log"</span></span><br><span class="line">        start_position =&gt; <span class="string">"beginning"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">    	split =&gt; &#123;<span class="string">"message"</span>=&gt;<span class="string">"|"</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">	stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动</span></span><br><span class="line">./bin/logstash -f ./mogublog-pipeline.conf</span><br></pre></td></tr></table></figure>

<p>然后我们就插入我们的测试数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"2019-03-15 21:21:21|ERROR|读取数据出错|参数：id=1002"</span> &gt;&gt; app.log</span><br></pre></td></tr></table></figure>

<p>然后我们就可以看到logstash就会捕获到刚刚我们插入的数据，同时我们的数据也被分割了</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208190514463.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="输出到Elasticsearch"><a href="#输出到Elasticsearch" class="headerlink" title="输出到Elasticsearch"></a>输出到Elasticsearch</h3><p>我们可以修改我们的配置文件，将我们的日志记录输出到ElasticSearch中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; <span class="string">"/soft/beats/logs/app.log"</span></span><br><span class="line">        start_position =&gt; <span class="string">"beginning"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">    	split =&gt; &#123;<span class="string">"message"</span>=&gt;<span class="string">"|"</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">	elasticsearch &#123;</span><br><span class="line">		hosts =&gt; [<span class="string">"127.0.0.1:9200"</span>]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在重启我们的logstash</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/logstash -f ./mogublog-pipeline.conf</span><br></pre></td></tr></table></figure>

<p>然后向日志记录中，插入两条数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"2019-03-15 21:21:21|ERROR|读取数据出错|参数：id=1002"</span> &gt;&gt; app.log</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"2019-03-15 21:21:21|ERROR|读取数据出错|参数：id=1002"</span> &gt;&gt; app.log</span><br></pre></td></tr></table></figure>

<p>最后就能够看到我们刚刚插入的数据了</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208195936769.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h1 id="ElasticStack综合案例"><a href="#ElasticStack综合案例" class="headerlink" title="ElasticStack综合案例"></a>ElasticStack综合案例</h1><p>本篇将我们前面学习到的技术：ElasticSearch、Beats、Kibana、Logstash 整合起来，做一个综合性的学习，目的是为了让小伙伴们能够更加深刻的理解ElasticStack的使用</p>
<h2 id="流程说明"><a href="#流程说明" class="headerlink" title="流程说明"></a>流程说明</h2><p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208200239859.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<ul>
<li>应用APP生产日志，用来记录用户的操作<ul>
<li>[INFO] 2019-03-15 22:55:20 [Main] - DAU|5206|使用优惠券|2019-03-15 03:37:20</li>
<li>[INFO] 2019-03-15 22:55:21 [Main] - DAU|3880|浏览页面|2019-03-15 07:25:09</li>
</ul>
</li>
<li>通过Filebeat读取日志文件中的内容，并且将内容发送给Logstash，原因是需要对内容做处理</li>
<li>Logstash接收到内容后，进行处理，如分割操作，然后将内容发送到Elasticsearch中</li>
<li>Kibana会读取Elasticsearch中的数据，并且在Kibana中进行设计Dashboard，最后进行展示</li>
</ul>
<blockquote>
<p>说明：日志格式、图表、Dashboard都是自定义的</p>
</blockquote>
<h2 id="App介绍"><a href="#App介绍" class="headerlink" title="App介绍"></a>App介绍</h2><p>APP在生产环境应该是真实系统，然而，现在我们学习的话，为了简化操作，所以就做数据的模拟生成即可。</p>
<p>业务代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.RandomUtils;</span><br><span class="line"><span class="keyword">import</span> org.joda.time.DateTime;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] VISIT = <span class="keyword">new</span> String[]&#123;<span class="string">"浏览页面"</span>, <span class="string">"评论商品"</span>, <span class="string">"加入收藏"</span>, <span class="string">"加入购物车"</span>, <span class="string">"提交订单"</span>, <span class="string">"使用优惠券"</span>, <span class="string">"领取优惠券"</span>, <span class="string">"搜索"</span>, <span class="string">"查看订单"</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            Long sleep = RandomUtils.nextLong(<span class="number">200</span>, <span class="number">1000</span> * <span class="number">5</span>);</span><br><span class="line">            Thread.sleep(sleep);</span><br><span class="line">            Long maxUserId = <span class="number">9999L</span>;</span><br><span class="line">            Long userId = RandomUtils.nextLong(<span class="number">1</span>, maxUserId);</span><br><span class="line">            String visit = VISIT[RandomUtils.nextInt(<span class="number">0</span>, VISIT.length)];</span><br><span class="line">            DateTime now = <span class="keyword">new</span> DateTime();</span><br><span class="line">            <span class="keyword">int</span> maxHour = now.getHourOfDay();</span><br><span class="line">            <span class="keyword">int</span> maxMillis = now.getMinuteOfHour();</span><br><span class="line">            <span class="keyword">int</span> maxSeconds = now.getSecondOfMinute();</span><br><span class="line">            String date = now.plusHours(-(RandomUtils.nextInt(<span class="number">0</span>, maxHour)))</span><br><span class="line">                    .plusMinutes(-(RandomUtils.nextInt(<span class="number">0</span>, maxMillis)))</span><br><span class="line">                    .plusSeconds(-(RandomUtils.nextInt(<span class="number">0</span>, maxSeconds)))</span><br><span class="line">                    .toString(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line"></span><br><span class="line">            String result = <span class="string">"DAU|"</span> + userId + <span class="string">"|"</span> + visit + <span class="string">"|"</span> + date;</span><br><span class="line">            log.error(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以启动运行，就是不断的生成日志，模拟了我们的实际业务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">09:18:32.721 [main] ERROR com.log.Main - DAU|8183|加入购物车|2020-09-25 06:10:25</span><br><span class="line">09:18:33.599 [main] ERROR com.log.Main - DAU|7097|提交订单|2020-09-25 06:18:31</span><br><span class="line">09:18:37.265 [main] ERROR com.log.Main - DAU|1468|查看订单|2020-09-25 02:04:10</span><br><span class="line">09:18:39.634 [main] ERROR com.log.Main - DAU|7821|领取优惠券|2020-09-25 02:04:07</span><br><span class="line">09:18:41.909 [main] ERROR com.log.Main - DAU|7962|提交订单|2020-09-25 03:02:39</span><br><span class="line">09:18:43.596 [main] ERROR com.log.Main - DAU|3358|评论商品|2020-09-25 08:14:19</span><br></pre></td></tr></table></figure>

<p>然后我们将该项目使用下面命令进行打包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install</span><br></pre></td></tr></table></figure>

<p>打包完成后，到target目录下，能够看到我们生成的jar包</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208203332849.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>我们将其复制到我们的服务器上，然后创建一个启动的脚本 startup.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash     </span></span><br><span class="line">nohup java  -Xms256m -Xmx512m -jar  mogu-dashboard-generate-0.0.1-SNAPSHOT.jar  &gt; app.log  2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>

<p>然后就使用脚本进行启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">./startup.sh</span><br><span class="line"><span class="comment"># 启动成功后，会看到一个日志 app.log，我们可以查看</span></span><br><span class="line">tail -f app.log</span><br></pre></td></tr></table></figure>

<h2 id="配置Filebeat"><a href="#配置Filebeat" class="headerlink" title="配置Filebeat"></a>配置Filebeat</h2><p>在有了不断产生日志的应用程序后，我们就需要创建一个Filebeat的配置文件，用于日志的收集</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开配置文件</span></span><br><span class="line">vim  mogu-dashboard.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入数据</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  paths:</span><br><span class="line">    - /soft/app/*.<span class="built_in">log</span></span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 1</span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [<span class="string">"127.0.0.1:5044"</span>]</span><br></pre></td></tr></table></figure>

<p>然后我们就可以启动了【需要我们把Logstash启动起来】</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -e -c mogu-dashboard.yml</span><br></pre></td></tr></table></figure>

<h2 id="配置Logstash"><a href="#配置Logstash" class="headerlink" title="配置Logstash"></a>配置Logstash</h2><h3 id="Logstash输出到控制台"><a href="#Logstash输出到控制台" class="headerlink" title="Logstash输出到控制台"></a>Logstash输出到控制台</h3><p>Logstash的主要目的就是处理Filebeat发送过来的数据，进行数据的清洗，过滤等，我们首先简单的将logstash获得的数据输出到控制台</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开配置文件</span></span><br><span class="line">vim  mogu-dashboard.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加以下内容</span></span><br><span class="line">input &#123;</span><br><span class="line">	beats &#123;</span><br><span class="line">		port =&gt; <span class="string">"5044"</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">	stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后启动我们的logstash 【注意，启动时间比较长，需要我们等待】</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/logstash -f mogu-dashboard.conf</span><br></pre></td></tr></table></figure>

<p>启动logstash完成后，我们需要再次启动filebeat，回到上面的启动步骤，然后就能看到logstash输出我们的日志</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208210103660.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="配置Logstash连接ElasticSearch"><a href="#配置Logstash连接ElasticSearch" class="headerlink" title="配置Logstash连接ElasticSearch"></a>配置Logstash连接ElasticSearch</h3><p>上面的数据，其实还是我们的原始数据，并没有经过处理，所以我们这个时候就需要使用到Logstash的其它功能了。我们继续修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开配置文件</span></span><br><span class="line">vim  mogu-dashboard.conf</span><br></pre></td></tr></table></figure>

<p>然后修改一下的值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">        beats &#123;</span><br><span class="line">                port =&gt; <span class="string">"5044"</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">                split =&gt; &#123;<span class="string">"message"</span>=&gt;<span class="string">"|"</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mutate &#123;</span><br><span class="line">                add_field =&gt; &#123;</span><br><span class="line">                <span class="string">"userId"</span> =&gt; <span class="string">"%&#123;[message][1]&#125;"</span></span><br><span class="line">                <span class="string">"visit"</span> =&gt; <span class="string">"%&#123;[message][2]&#125;"</span></span><br><span class="line">                <span class="string">"date"</span> =&gt; <span class="string">"%&#123;[message][3]&#125;"</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mutate &#123;</span><br><span class="line">                convert =&gt; &#123;</span><br><span class="line">                <span class="string">"userId"</span> =&gt; <span class="string">"integer"</span></span><br><span class="line">                <span class="string">"visit"</span> =&gt; <span class="string">"string"</span></span><br><span class="line">                <span class="string">"date"</span> =&gt; <span class="string">"string"</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mutate &#123;</span><br><span class="line">           remove_field =&gt; [ <span class="string">"host"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#output &#123;</span></span><br><span class="line"><span class="comment"># stdout &#123; codec =&gt; rubydebug &#125;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [ <span class="string">"127.0.0.1:9200"</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再次启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/logstash -f mogu-dashboard.conf</span><br></pre></td></tr></table></figure>

<p>其实能够看到，我们原来的数据，就经过了处理了，产生了新的字段</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/2020120821033359.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>同时我们还可以对我们的数据，进行类型转换，为了方便我们的下游进行处理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mutate &#123;</span><br><span class="line">	convert =&gt; &#123;</span><br><span class="line">	<span class="string">"userId"</span> =&gt; <span class="string">"integer"</span></span><br><span class="line">	<span class="string">"visit"</span> =&gt; <span class="string">"string"</span></span><br><span class="line">	<span class="string">"date"</span> =&gt; <span class="string">"string"</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="遇到的问题1"><a href="#遇到的问题1" class="headerlink" title="遇到的问题1"></a>遇到的问题1</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[2020-09-25T02:32:44,042][WARN ][logstash.filters.mutate  ][main][5fd6a2f2f396816d849f2e3e2e0a53f2500a9b58c6819e23f42d2bfd34cde207] Exception caught <span class="keyword">while</span> applying mutate filter &#123;:exception=&gt;<span class="string">"Invalid FieldReference: `message[1]`"</span>&#125;</span><br></pre></td></tr></table></figure>

<p>不断的刷这个错误，配置文件没问题，但添加字段那一个mutate需要给message套一层中括号：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mutate &#123;</span><br><span class="line">    add_field =&gt; &#123;</span><br><span class="line">        <span class="string">"userId"</span> =&gt; <span class="string">"%&#123;[message][1]&#125;"</span></span><br><span class="line">        <span class="string">"visit"</span> =&gt; <span class="string">"%&#123;[message][2]&#125;"</span></span><br><span class="line">        <span class="string">"date"</span> =&gt; <span class="string">"%&#123;[message][3]&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="遇到的问题2"><a href="#遇到的问题2" class="headerlink" title="遇到的问题2"></a>遇到的问题2</h3><p>filebeat 传输到host的字段中host是一个对象</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">failed to parse field [host] of <span class="built_in">type</span> [text] <span class="keyword">in</span> document</span><br></pre></td></tr></table></figure>

<p>解决方法就是过滤掉host字段</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mutate &#123;</span><br><span class="line">	remove_field =&gt; [ <span class="string">"host"</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="启动ElasticSearch-1"><a href="#启动ElasticSearch-1" class="headerlink" title="启动ElasticSearch"></a>启动ElasticSearch</h2><p>在我们通过Logstash发送数据到ElasticSearch，所以我们还需要启动我们的ElasticSearch</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换到elsearch用户</span></span><br><span class="line">su elsearch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 到目录</span></span><br><span class="line"><span class="built_in">cd</span> /soft/elsearch/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">./elasticsearch</span><br></pre></td></tr></table></figure>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208211345501.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="启动Kibana"><a href="#启动Kibana" class="headerlink" title="启动Kibana"></a>启动Kibana</h2><p>我们最后就需要通过Kibana来展示我们的图形化数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动kibana</span></span><br><span class="line">./bin/kibana</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过浏览器访问</span></span><br><span class="line">http://202.193.56.222:5601/app/kibana</span><br></pre></td></tr></table></figure>

<h3 id="添加到索引库"><a href="#添加到索引库" class="headerlink" title="添加到索引库"></a>添加到索引库</h3><p>添加Logstash索引到Kibana中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://202.193.56.222:5601/app/management/kibana/indexPatterns/create</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208211904457.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>输入我们的匹配规则，然后匹配到logstash，然后选择时间字段后创建</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/2020120821191479.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="创建柱形图"><a href="#创建柱形图" class="headerlink" title="创建柱形图"></a>创建柱形图</h3><p>我们点击右侧Visualizations，然后开始创建图标</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208211924241.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>然后选择柱形图</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208211942497.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>在选择我们的索引</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208212051923.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>最后我们定义我们的X轴，选择按照时间进行添加</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208211952970.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>最后更新我们的页面，然后在选择最近的30分钟</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208212005235.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>就能够看到我们的日志在源源不断的生成了，同时我们可以对我们的这个图表进行保存</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208212018427.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="创建饼图"><a href="#创建饼图" class="headerlink" title="创建饼图"></a>创建饼图</h3><p>我们继续选择饼图</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208212310866.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>然后选择我们的索引</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208212325588.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>添加完成后，我们就看到这样一个页面了</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208212337610.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>但是这样还不死很直观，所以我们还需要做处理，找到右侧的Buckets，然后选择Split Slices，然后把我们的每个字段都添加上去，其中visit指的是我们es中的属性</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208212350711.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>最后选择update，得到的效果如下所示</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208213725559.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>我们还可以继续给每个字段都添加label标签</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208212419749.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>添加完成后，更新页面，就得到非常不错的效果了~</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208212432577.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="数据表格"><a href="#数据表格" class="headerlink" title="数据表格"></a>数据表格</h3><p>在图标中，选择我们需要显示的字段即可</p>
<p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208214027531.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208214419478.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="制作Dashboard"><a href="#制作Dashboard" class="headerlink" title="制作Dashboard"></a>制作Dashboard</h2><p><img src= "/img/loading.gif" data-src="https://img-blog.csdnimg.cn/20201208214051164.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODE3MTY0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:1442243445@qq.com">小小王</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/11/22/elasticsearch/">http://yoursite.com/2020/11/22/elasticsearch/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">Wang</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/elasticsearch/">elasticsearch</a></div><div class="post_share"><div class="social-share" data-image="/img/bg4.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/11/26/webpack/"><img class="prev-cover" data-src="/img/bg6.jpg" onerror="onerror=null;src='/'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">webpack入门</div></div></a></div><div class="next-post pull-right"><a href="/2020/11/18/Design%20patterns/"><img class="next-cover" data-src="/img/bg6.jpg" onerror="onerror=null;src='/'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">设计模式</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By 小小王</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="icp"><a href="http://beian.miit.gov.cn" target="_blank" rel="noopener"><img class="icp-icon" src="/img/icp.png"/><span>粤ICP备20054751</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="readmode" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" title="缩小字体"><i class="fas fa-minus"></i></button><button class="translate_chn_to_cht" id="translateLink" title="简繁转换">繁</button><button id="darkmode" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="ribbon_piao" mobile="true" src="/js/third-party/piao.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/js/third-party/canvas-nest.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script src="/js/search/local-search.js"></script><script src="js/move_mouse/script.js"></script><script src="https://cdn.jsdelivr.net/gh/sviptzk/StaticFile_HEXO@latest/butterfly/js/pool.min.js"></script><script src="/js/down_mouse/love.js"></script></body></html>